NULL=0
ONES=1
TWO=2
ORGANISM=`cat $WORKDIR/ORGANISM`                    #getting the organism type from the main script
cancer_type=`cat $WORKDIR/cancer_type`              #getting the cancer type from the main script
CANCER_PATHWAY=$ORGANISM$cancer_type                #setting the cancer pathway
therapy_level=`cat $WORKDIR/therapy_level`         #therapy level
compute_cell_line=`cat $WORKDIR/compute_cell_line`
cosmic=`cat $WORKDIR/cosmic`
cell_line=`cat cell_line`                  #getting the cell line name
job_status=`cat job_status`       
job_submit=`cat job_submit`
exhaustiveness=`cat $WORKDIR/exhaustiveness`
box_size=`cat $WORKDIR/box_size`
random_affinity=`cat $WORKDIR/random_affinity`
max_jobs=`cat $WORKDIR/max_jobs` #maximum number of Vina jobs
MAX_NODES=`cat $WORKDIR/nodes`       #maximum number of compute nodes Vini can use concurrently
partition=`cat cpu_partition`
walltime=`sinfo | grep $partition | head -1 | awk '{print $3}'` #By default we are running Vini jobs on cpu nodes
excluded_nodes=`cat excluded_${partition}_nodes`
complexes=`wc -l < $WORKDIR/receptors_contracted`
ligands=`wc -l < $vini_dir/ligands/ligands_list`
lig_source=$WORKDIR/ligands

mkdir -p $WORKDIR/${CANCER_PATHWAY}_results #Create directory for results
cd $WORKDIR

L1=1; L2=1; L3=1; L4=1;                 #Initializing main loops
case $therapy_level in                  
     1) L4=$ligands ;;
     2) L3=$ligands; L4=$ligands ;;
     3) L2=$ligands; L3=$ligands; L4=$ligands ;;
     4) L1=$ligands; L2=$ligands; L3=$ligands; L4=$ligands ;;
esac

state=`cat $vini_dir/state`                 #setting loop control parameters
dir=$WORKDIR/${cancer_type}_data 
if  [ $state == crash ]
then
    ligand_number=`grep ligand_number $WORKDIR/restartfile | awk '{print $2}'`
    Kappa=`grep          I         $WORKDIR/restartfile | awk '{print $2}'`
    Lambda=`grep         J         $WORKDIR/restartfile | awk '{print $2}'`
    Mu=`grep             L         $WORKDIR/restartfile | awk '{print $2}'`
    Nu=`grep             M         $WORKDIR/restartfile | awk '{print $2}'`
    Xi=$ONES
    echo "deleting SLEM values after the last checkpoint"
    MaxSLEMvalues=`echo ${Kappa} ${Lambda} ${Mu} ${Nu} ${Xi} ${ligands} | awk '{print $1 * $2 * $3 * $4 * $5 * $6 }'`
    NoSLEMvalues=`echo ${Kappa} ${Lambda} ${Mu} ${Nu} ${Xi} ${ligand_number} | awk '{print $1 * $2 * $3 * $4 * $5 * $6 }'`
    Delete=`echo $MaxSLEMvalues $NoSLEMvalues $ONES | awk '{print $1 - $2 - $3}'`
    head -$Delete $vini_dir/ligands/ligands_list > $WORKDIR/tmp
    mv $WORKDIR/tmp $WORKDIR/SLEM_values
else
    ligand_number=1                #initializing ligand index
    Kappa=$ONES
    Lambda=$ONES
    Mu=$ONES
    Nu=$ONES
    Xi=$ONES
    > $WORKDIR/SLEM_values    #delete SLEM values from the previous run
fi
 
SECONDS=$NULL

echo "Calculating free binding energies for therapy level ${therapy_level}. This may take a while, please be patient."

for (( I=$((Kappa)); I<$((L1+1)); I++ )) #1st loop - 4th therapy level
do
    for (( J=$((Lambda)); J<$((L2+1)); J++ )) #2nd loop -3rd therapy level
    do
         for (( L=$((Mu)); L<$((L3+1)); L++ )) #3rd loop -2nd thl
         do
             for (( M=$((Nu)); M<$((L4+1)); M++ )) #4th loop - 1st thl
             do
                 printf -v lig_index "%03d" $M  
                 case $therapy_level in
                     1) comp_source=$dir;          target_dir=$dir/$M ;;
                     2) comp_source=$dir/$M;       target_dir=$dir/$M/$L ;;
                     3) comp_source=$dir/$M/$L;    target_dir=$dir/$M/$L/$J ;;
                     4) comp_source=$dir/$M/$L/$J; target_dir=$dir/$M/$L/$J/$I ;;
                 esac
                 mkdir -p $comp_source $target_dir # nr. of target dirs equals nr. of ligands
                 for (( N=$((Xi)); N<$((complexes+1)); N++ )) #5th loop
       	         do
                     printf -v n "%03d" $N
                     comp_index=$n
                     conf_index=$comp_index
                     log_index=$comp_index
                     line=`head -"$ligand_number" $vini_dir/ligands/ligands_list | tail -1`
                     drug=`echo $line | awk -F',' '{print $1}'`
                     drugtype=`echo $line | awk -F','  '{print $2}'`
                     mkdir -p $WORKDIR/$comp_index
                     cd $WORKDIR/$comp_index   #move to the working area
                     rm -rf *
                     cp $comp_source/complex_${comp_index}.pdb ./
                     if  [ ! -e $comp_source/complex_${comp_index}.pdb ]
                     then
                         echo "error" > $target_dir/log_${log_index}
                     else
                         cp $comp_source/complex_${comp_index}.pdb ./     #prepare receptor
                         >tmp
                         grep -v COMPND complex_${comp_index}.pdb > tmp
                         if  [ ! -s tmp ]
                         then
                             sed -i '$ d' complex_${comp_index}.pdb
                             grep -w TER complex_${comp_index}.pdb > tmp
                             if  [ -s tmp ]
                             then
                                 echo "TER                                                                            " >> complex_${comp_index}.pdb
                             fi
                             source $INSTALL/miniconda2/bin/activate
                             cp $ROSETTA_TOOLS/amino_acids.py ./
                             cp $ROSETTA_PUB/clean_pdb_keep_ligand.py ./
                             python clean_pdb_keep_ligand.py complex_${comp_index}.pdb -ignorechain
                             mv complex_${comp_index}.pdb_00.pdb complex_${comp_index}.pdb
                             conda deactivate
                         fi
                         cp $WORKDIR/ligands_stage/ligand_${lig_index}.pdb ./
                         cp $vini_dir/dock.xml ./
                         cp $vini_dir/docking.mac ./      #prepare files for Hex
                         if  [ $drugtype == S ]
                         then
                             if [[ $genename == C* ]]
                             then
                                 cp $vini_dir/flag_ligand_docking #Performing protein-ligand docking
                                 cp complex_${comp_index}.pdb receptor.pdb
                                 cp ligand_${lig_index}.pdb ligand.pdb
                                 echo "#!/bin/bash"                                                                    > dock
                                 echo "#SBATCH --time=$walltime"                                                      >> dock
                                 echo "#SBATCH --account=$SLURMACCT"                                                  >> dock
                                 echo "#SBATCH --partition=$partition"                                                >> dock
                                 echo "#SBATCH --nodes=1"                                                             >> dock
                                 echo "#SBATCH --ntasks=1"                                                            >> dock
                                 echo "#SBATCH --cpus-per-task=48"                                                    >> dock
                                 echo "#SBATCH --job-name=R${M}.${N}"                                                 >> dock
                                 echo "#SBATCH --output=${target_dir}/R_${M}_${N}.out"                                >> dock
                                 echo "#SBATCH --error=${target_dir}/R_${M}_${N}.err"                                 >> dock
                                 echo "#SBATCH --exclude=${excluded_nodes}"                                           >> dock 
                                 echo "$INSTALL/bcl-master/build/linux64_release/bin/bcl-apps.exe molecule:ConformerGenerator -ensemble_filenames $WORKDIR/ligands_stage/ligand_${lig_index}.sdf -conformers_single_file ligand_${lig_index}_conformers.sdf -max_iterations 500 -top_models 50" >> dock
                                 echo "python $ROSETTA/source/scripts/python/public/molfile_to_params.py -n LIG -p ligand_${lig_index} --clobber --conformers-in-one-file ligand_${lig_index}_conformers.sdf"                                            >> dock
                                 echo "sed -i -e 's/LIG.params/ligand_${lig_index}.params/g' flag_ligand_docking"     >> dock
                                 echo "cp ligand_${lig_index}.pdb ligand.pdb"                                         >> dock
                                 echo "hex -batch receptor.pdb ligand.pdb < docking.mac > docking.log"                >> dock
                                 echo "grep -v REMARK complex.pdb > tmp"                                              >> dock
                                 echo "sed -i '$ d' tmp"                                                              >> dock
                                 echo "echo  \"TER                                                                             \" >> tmp" >> dock
                                 echo "mv tmp crystal_complex.pdb"                                                    >> dock
                                 echo "cat complex_${comp_index}.pdb ligand_${lig_index}.pdb > complex_${comp_index}_ligand_${lig_index}.pdb" >> dock
                                 echo "rosetta_scripts.cxx11thread.linuxgccrelease -in:file:s complex_${comp_index}_ligand_${lig_index}.pdb -multithreading:total_threads 48 @flag_ligand_docking"                                                                      >> dock
                                 echo "if [ -e ROSETTA_CRASH.log ] ; then"                                            >> dock
                                 echo "echo ERROR > $target_dir/log_${comp_index}"                                    >> dock
                                 echo "else"                                                                          >> dock
                                 echo "score=\`grep SCORE score.sc | grep -v total_score | awk '{print \$2}' | sort -n | head -1\`" >> dock
                                 echo "echo \${score} > $target_dir/log_${comp_index}"                                >> dock
                                 echo "cp complex_${comp_index}_ligand_${lig_index}_0001.pdb $target_dir/complex_${comp_index}.pdb" >> dock
                                 echo "fi"                                                                            >> dock
                             else
                                 echo "Generating complex with AD Vina."
                                 cp $MGLTOOLS/AD4_parameters.dat ./
                                 if  [ ! -e ${comp_source}/complex_${comp_index}.pdbqt ] #get receptor pdbqt file
                                 then
                                     $MGLBIN/pythonsh $MGLUTILS/prepare_receptor4.py -r $comp_source/complex_$comp_index.pdb -o $comp_source/complex_${comp_index}.pdbqt
                                 else
                                     cp ${comp_source}/complex_${comp_index}.pdbqt ./
                                 fi

                                 if  [ -e $WORKDIR/ligands/ligand_${lig_index}.pdbqt ]    #get ligand pdbqt file
                                 then
                                     cp $WORKDIR/ligands/ligand_${lig_index}.pdbqt ./
                                 else
                                     cp $vini_dir/ligands/pdb_files/"${drug}".pdb ./
                                     ls "${drug}".pdb > tmp
                                     nowords=`wc -w < tmp`
                                     if  [ $nowords -eq $ONES ]
                                     then
                                         $MGLBIN/pythonsh $MGLTOOLS/Utilities24/prepare_ligand4.py -l "${drug}".pdb -o $WORKDIR/ligands/ligand_${lig_index}.pdbqt
                                     else
                                         mv "${drug}".pdb tmp.pdb        #python does not work with 2-name drug
                                         $MGLBIN/pythonsh $MGLTOOLS/Utilities24/prepare_ligand4.py -l tmp.pdb -o tmp.pdbqt
                                         mv tmp.pdbqt  $WORKDIR/ligands/ligand_${lig_index}.pdbqt
                                     fi
                                 fi

                                 $MGLBIN/pythonsh $MGLUTILS/prepare_gpf.py -l ligand_${lig_index}.pdbqt -r complex_${comp_index}.pdbqt
                                 sh $vini_dir/create_Vina_config_file ${lig_index} ${comp_index} ${conf_index} ${comp_source}
                                 echo "#!/bin/bash"                                        > dock
                                 echo "#SBATCH --time="$walltime                          >> dock
                                 echo "#SBATCH --account=$SLURMACCT"                      >> dock
                                 echo "#SBATCH --partition="$partition                    >> dock
                                 echo "#SBATCH --nodes=1"                                 >> dock
                                 echo "#SBATCH --ntasks=1"                                >> dock
                                 echo "#SBATCH --cpus-per-task=48"                        >> dock
                                 echo "#SBATCH --job-name=Vina_${M}_${N}"                 >> dock
                                 echo "#SBATCH --output=${target_dir}/Vina_${M}_${N}.out" >> dock
                                 echo "#SBATCH --exclude=${excluded_nodes}"               >> dock
                                 echo "vina --cpu 48 --size_x 40 --size_y 40 --size_z 40 --config $comp_source/conf_$conf_index.txt --exhaustiveness ${exhaustiveness} --receptor $comp_source/complex_${comp_index}.pdbqt --ligand ligand_${lig_index}.pdbqt --out $target_dir/complex_${comp_index}.pdbqt > $target_dir/log_$log_index.txt"                   >> dock
                                 #cat $vini_dir/log_Vina_IC_value                         >> dock
                                 chmod u+x dock
                                 sh $vini_dir/jobs_control_script ${job_status} ${max_jobs}
                                 ${job_submit} dock


                             fi
                         else              
                             genename=`head -1 complex_${comp_index}.pdb | awk '{print $1}'`
                             if [[ $genename == C* ]]
                             then
                                 cp complex_${comp_index}.pdb tmp #Swapping protein-ligand and performing protein-ligand docking
                                 cp ligand_${lig_index}.pdb complex_${comp_index}.pdb
                                 cp tmp ligand_${lig_index}.pdb
                                 cp complex_${comp_index}.pdb receptor.pdb
                                 cp ligand_${lig_index}.pdb ligand.pdb
                                 cp $vini_dir/flag_ligand_docking ./
                                 echo "#!/bin/bash"                                                                    > dock
                                 echo "#SBATCH --time=$walltime"                                                      >> dock
                                 echo "#SBATCH --account=$SLURMACCT"                                                  >> dock
                                 echo "#SBATCH --partition=$partition"                                                >> dock
                                 echo "#SBATCH --nodes=1"                                                             >> dock
                                 echo "#SBATCH --ntasks=1"                                                            >> dock
                                 echo "#SBATCH --cpus-per-task=48"                                                    >> dock
                                 echo "#SBATCH --job-name=R${M}.${N}"                                                >> dock
                                 echo "#SBATCH --output=${target_dir}/R_${M}_${N}.out"                                >> dock
                                 echo "#SBATCH --error=${target_dir}/R_${M}_${N}.err"                                 >> dock
                                 echo "#SBATCH --exclude=${excluded_nodes}"                                           >> dock
                                 echo "$INSTALL/bcl-master/build/linux64_release/bin/bcl-apps.exe molecule:ConformerGenerator -ensemble_filenames $WORKDIR/ligands_stage/ligand_${lig_index}.sdf -conformers_single_file ligand_${lig_index}_conformers.sdf -max_iterations 500 -top_models 50" >> dock
                                 echo "python $ROSETTA/source/scripts/python/public/molfile_to_params.py -n LIG -p ligand_${lig_index} --clobber --conformers-in-one-file ligand_${lig_index}_conformers.sdf"                                            >> dock
                                 echo "sed -i -e 's/LIG.params/ligand_${lig_index}.params/g' flag_ligand_docking"     >> dock
                                 echo "cp ligand_${lig_index}.pdb ligand.pdb"                                         >> dock
                                 echo "hex -batch receptor.pdb ligand.pdb < docking.mac > docking.log"                >> dock
                                 echo "grep -v REMARK complex.pdb > tmp"                                              >> dock
                                 echo "sed -i '$ d' tmp"                                                              >> dock
                                 echo "echo  \"TER                                                                             \" >> tmp" >> dock
                                 echo "mv tmp crystal_complex.pdb"                                                    >> dock
                                 echo "cat complex_${comp_index}.pdb ligand_${lig_index}.pdb > complex_${comp_index}_ligand_${lig_index}.pdb" >> dock
                                 echo "rosetta_scripts.cxx11thread.linuxgccrelease -in:file:s complex_${comp_index}_ligand_${lig_index}.pdb -multithreading:total_threads 48 @flag_ligand_docking"                                                                      >> dock
                                 echo "if [ -e ROSETTA_CRASH.log ] ; then"                                            >> dock
                                 echo "echo ERROR > $target_dir/log_${comp_index}"                                    >> dock
                                 echo "else"                                                                          >> dock
                                 echo "score=\`grep SCORE score.sc | grep -v total_score | awk '{print \$2}' | sort -n | head -1\`" >> dock
                                 echo "echo \${score} > $target_dir/log_${comp_index}"                                >> dock
                                 echo "cp complex_${comp_index}_ligand_${lig_index}_0001.pdb $target_dir/complex_${comp_index}.pdb" >> dock
                             else
                                 fasta_file=${vini_dir}/ligands/fasta_files/${drug}.fasta #set chains ID in ligand #protein-protein docking
                                 chains=`grep -c ">" ${fasta_file}`     
                                 if  [ $chains -eq $ONES ]
                                 then
                                     java -jar $vini_dir/PDBChainNameSupstitutor-1.0-SNAPSHOT-shaded.jar ligand_${lig_index}.pdb A Z
                                     mv ligand_${lig_index}.pdb_A_to_Z.pdb ligand_${lig_index}.pdb
                                 else
                                     java -jar $vini_dir/PDBChainNameSupstitutor-1.0-SNAPSHOT-shaded.jar ligand_${lig_index}.pdb B Z
                                     java -jar $vini_dir/PDBChainNameSupstitutor-1.0-SNAPSHOT-shaded.jar ligand_${lig_index}.pdb_B_to_Z.pdb A Q
                                     mv ligand_${lig_index}.pdb_B_to_Z.pdb_A_to_Q.pdb ligand_${lig_index}.pdb
                                     sh $vini_dir/jobs_control_script ${job_status} ${max_jobs}
                                 fi
                                 cp $vini_dir/flag_input_relax $vini_dir/flag_global_docking ./
                                 echo "#!/bin/bash"                                                             > dock
                                 echo "#SBATCH --time=$walltime"                                               >> dock
                                 echo "#SBATCH --account=$SLURMACCT"                                           >> dock
                                 echo "#SBATCH --partition=$partition"                                         >> dock
                                 echo "#SBATCH --nodes=1"                                                      >> dock
                                 echo "#SBATCH --ntasks=1"                                                     >> dock
                                 echo "#SBATCH --cpus-per-task=48"                                             >> dock
                                 echo "#SBATCH --job-name=R${M}.${N}"                                          >> dock
                                 echo "#SBATCH --output=${target_dir}/R_${M}_${N}.out"                         >> dock
                                 echo "#SBATCH --error=${target_dir}/R_${M}_${N}.err"                          >> dock
                                 echo "#SBATCH --exclude=${excluded_nodes}"                                    >> dock 
                                 echo "cp complex_${comp_index}.pdb receptor.pdb"                              >> dock
                                 echo "cp ligand_${lig_index}.pdb ligand.pdb"                                  >> dock
                                 echo "hex -batch receptor.pdb ligand.pdb < docking.mac > docking.log"         >> dock
                                 echo "cp complex.pdb complex_${comp_index}.pdb"                               >> dock
                                 echo "relax.cxx11thread.linuxgccrelease -in:file:s complex_${comp_index}.pdb -multithreading:total_threads 48 @flag_input_relax"                                                                                                >> dock
                                 echo "docking_protocol.cxx11thread.linuxgccrelease -in:file:s complex_${comp_index}_0002.pdb -multithreading:total_threads 48 @flag_global_docking"                                                                             >> dock
                                 echo "if [ -e ROSETTA_CRASH.log ] ; then"                                     >> dock
                                 echo "echo "ERROR" > $target_dir/log_${comp_index}"                           >> dock
                                 echo "else"                                                                   >> dock
                                 echo "cp complex_${comp_index}_0002_0001.pdb $target_dir/complex_${comp_index}.pdb"  >> dock
                                 echo "grep complex_${comp_index}_0002_0001 score.sc | awk '{print  \$2}' > $target_dir/log_${comp_index}" >> dock
                                 echo "fi"                                                                     >> dock
                             fi
                         fi
                     fi
                     chmod u+x                                                                                        dock         
                     sh $vini_dir/jobs_control_script ${job_status} ${max_jobs}
                     ${job_submit}                                                                                    dock
                     sh $vini_dir/write_checkpoint ${ligand_number} ${I} ${J} ${L} ${M}    #write restart point
    	         done # end of 5th loop

                 echo "brakepoint! lig_index: ${lig_index} target_dir: ${target_dir}" ; sleep 1000
                 
                 cd $WORKDIR
                 sh $vini_dir/wait_until_jobs_finish

                 echo "Creating binding energy vector, please wait."
                 rm -f ${target_dir}/vec*
                 echo "#!/bin/bash"                                           > ${target_dir}/vec_${lig_index}
                 echo "#SBATCH --time="$walltime                             >> ${target_dir}/vec_${lig_index}
                 echo "#SBATCH --account=$SLURMACCT"                         >> ${target_dir}/vec_${lig_index}
                 echo "#SBATCH --partition="$partition                       >> ${target_dir}/vec_${lig_index}
                 echo "#SBATCH --ntasks=1"                                   >> ${target_dir}/vec_${lig_index}
                 echo "#SBATCH --cpus-per-task=1"                            >> ${target_dir}/vec_${lig_index}
                 echo "#SBATCH --job-name=vec_${lig_index}"                  >> ${target_dir}/vec_${lig_index}
                 echo "#SBATCH --output=${target_dir}/vec_${lig_index}.out"  >> ${target_dir}/vec_${lig_index}
                 echo "#SBATCH --output=${target_dir}/vec_${lig_index}.err"  >> ${target_dir}/vec_${lig_index}
                 echo "#SBATCH --exclude=${excluded_nodes}"                  >> ${target_dir}/vec_${lig_index} 
                 cat $vini_dir/create_vector                                 >> ${target_dir}/vec_${lig_index}
                 chmod u+x ${target_dir}/vec_${lig_index}
                 ${job_submit} ${target_dir}/vec_${lig_index} ${target_dir} ${WORKDIR}

                 sh $vini_dir/wait_until_jobs_finish
                 
                 echo "Creating binding energy matrix, please wait."
                 echo ${target_dir} > target_dir
                 echo "#!/bin/bash"                                          > ${target_dir}/mat_${lig_index}
                 echo "#SBATCH --time="$walltime                            >> ${target_dir}/mat_${lig_index}
                 echo "#SBATCH --cpus-per-task=1"                           >> ${target_dir}/mat_${lig_index}
                 echo "#SBATCH --mem=4gb"                                   >> ${target_dir}/mat_${lig_index}
                 echo "#SBATCH --partition="$partition                      >> ${target_dir}/mat_${lig_index}
                 echo "#SBATCH --job-name=mat_${lig_index}"                 >> ${target_dir}/mat_${lig_index}
                 echo "#SBATCH --account=$SLURMACCT"                        >> ${target_dir}/mat_${lig_index}
                 echo "#SBATCH --output=${target_dir}/mat_${lig_index}.out" >> ${target_dir}/mat_${lig_index}
                 echo "#SBATCH --error=${target_dir}/mat_${lig_index}.err"  >> ${target_dir}/mat_${lig_index}
                 echo "#SBATCH --exclude=${excluded_nodes}"                 >> ${target_dir}/mat_${lig_index} 
                 echo "WORKDIR=${WORKDIR}"                                  >> ${target_dir}/mat_${lig_index}
                 echo "source $INSTALL/miniconda3/bin/activate"             >> ${target_dir}/mat_${lig_index}
                 echo "conda activate env310"                               >> ${target_dir}/mat_${lig_index}
                 echo "python3 $vini_dir/create_energy_binding_matrix.py"   >> ${target_dir}/mat_${lig_index}
                 echo "conda deactivate"                                    >> ${target_dir}/mat_${lig_index}
                 chmod u+x ${target_dir}/mat_${lig_index}
                 ${job_submit} ${target_dir}/mat_${lig_index}
                 sh $vini_dir/wait_until_jobs_finish

                 echo "Calculating eigenvalues, please wait."
                 echo ${target_dir} > target_dir
                 echo "#!/bin/bash"                                            > ${target_dir}/eigen_${lig_index}
                 echo "#SBATCH --time="$walltime                              >> ${target_dir}/eigen_${lig_index}
                 echo "#SBATCH --cpus-per-task=1"                             >> ${target_dir}/eigen_${lig_index}
                 echo "#SBATCH --mem=4gb"                                     >> ${target_dir}/eigen_${lig_index}
                 echo "#SBATCH --partition="$partition                        >> ${target_dir}/eigen_${lig_index}
                 echo "#SBATCH --job-name=eigen_${lig_index}"                 >> ${target_dir}/eigen_${lig_index}
                 echo "#SBATCH --account=$SLURMACCT"                          >> ${target_dir}/eigen_${lig_index}
                 echo "#SBATCH --output=${target_dir}/eigen_${lig_index}.out" >> ${target_dir}/eigen_${lig_index}
                 echo "#SBATCH --error=${target_dir}/eigen_${lig_index}.err"  >> ${target_dir}/eigen_${lig_index}
                 echo "#SBATCH --exclude=${excluded_nodes}"                   >> ${target_dir}/eigen_${lig_index} 
                 echo "WORKDIR=${WORKDIR}"                                    >> ${target_dir}/eigen_${lig_index}
                 echo "source $INSTALL/miniconda3/bin/activate"               >> ${target_dir}/eigen_${lig_index}
                 echo "conda activate env310"                                 >> ${target_dir}/eigen_${lig_index}
                 echo "python3 $vini_dir/compute_eigenvalues.py -s $target_dir/EB_matrix -t $target_dir/E_Vina" >> ${target_dir}/eigen_${lig_index}
                 echo "conda deactivate"                                      >> ${target_dir}/eigen_${lig_index}
                 chmod u+x ${target_dir}/eigen_${lig_index}
                 ${job_submit} ${target_dir}/eigen_${lig_index}
                 sh $vini_dir/wait_until_jobs_finish

                 echo "Calculating SLEM, please wait."
                 echo "#!/bin/bash"                                           > ${target_dir}/select_${lig_index}
                 echo "#SBATCH --time="$walltime                             >> ${target_dir}/select_${lig_index}
                 echo "#SBATCH --cpus-per-task=1"                            >> ${target_dir}/select_${lig_index}
                 echo "#SBATCH --mem=4gb"                                    >> ${target_dir}/select_${lig_index}
                 echo "#SBATCH --partition="$partition                       >> ${target_dir}/select_${lig_index}
                 echo "#SBATCH --job-name=SLEM_${lig_index}"                 >> ${target_dir}/select_${lig_index}
                 echo "#SBATCH --account=$SLURMACCT"                         >> ${target_dir}/select_${lig_index}
                 echo "#SBATCH --output=${target_dir}/SLEM_${lig_index}.out" >> ${target_dir}/select_${lig_index}
                 echo "#SBATCH --error=${target_dir}/SLEM_${lig_index}.err"  >> ${target_dir}/select_${lig_index}
                 echo "#SBATCH --exclude=${excluded_nodes}"                  >> ${target_dir}/select_${lig_index} 
                 echo "WORKDIR=${WORKDIR}"                                   >> ${target_dir}/select_${lig_index}
                 cat $vini_dir/select_SLEM_value                             >> ${target_dir}/select_${lig_index}
                 chmod u+x ${target_dir}/select_${lig_index}
                 ${job_submit} ${target_dir}/select_${lig_index} ${M} ${L} ${J} ${I} ${target_dir} 
                 sh $vini_dir/wait_until_jobs_finish
                 let ligand_number++
             done   #end of 4thloop
         done       #end of 3rd loop
    done            #end of 2nd loop
done                #end of 1st loop

sh $vini_dir/wait_until_jobs_finish

if  [ $cosmic == y ] ; then
    exp=exp
else
    exp=noexp
fi

cp $WORKDIR/SLEM_values $WORKDIR/${CANCER_PATHWAY}_results/SLEM_values_${cell_line}_thl${therapy_level}_${exp}

echo "Deleting equal SLEM entries with equal indices, please wait..."
echo "#!/bin/bash"                                    > $WORKDIR/postproc
echo "#SBATCH --time="$walltime                      >> $WORKDIR/postproc
echo "#SBATCH --cpus-per-task=1"                     >> $WORKDIR/postproc
echo "#SBATCH --mem=4gb"                             >> $WORKDIR/postproc
echo "#SBATCH --partition="$partition                >> $WORKDIR/postproc
echo "#SBATCH --job-name=SLEM_${lig_index}"          >> $WORKDIR/postproc
echo "#SBATCH --account=$SLURMACCT"                  >> $WORKDIR/postproc
echo "#SBATCH --output=$WORKDIR/postproc1.out"       >> $WORKDIR/postproc
echo "#SBATCH --error=$WORKDIR/postproc1.err"        >> $WORKDIR/postproc
echo "#SBATCH --exclude=${excluded_nodes}"           >> $WORKDIR/postproc
echo "WORKDIR=${WORKDIR}"                            >> $WORKDIR/postproc
cat $vini_dir/delete_SLEM_entries_with_equal_indices >> $WORKDIR/postproc  
chmod u+x $WORKDIR/postproc
$job_submit $WORKDIR/postproc
sh $vini_dir/wait_until_jobs_finish

echo "Creating SLEM named lists, please wait."
echo "#!/bin/bash"                                    > $WORKDIR/postproc
echo "#SBATCH --time="$walltime                      >> $WORKDIR/postproc
echo "#SBATCH --cpus-per-task=1"                     >> $WORKDIR/postproc
echo "#SBATCH --mem=4gb"                             >> $WORKDIR/postproc
echo "#SBATCH --partition="$partition                >> $WORKDIR/postproc
echo "#SBATCH --job-name=SLEM_${lig_index}"          >> $WORKDIR/postproc
echo "#SBATCH --account=$SLURMACCT"                  >> $WORKDIR/postproc
echo "#SBATCH --output=$WORKDIR/postproc2.out"       >> $WORKDIR/postproc
echo "#SBATCH --error=$WORKDIR/postproc2.err"        >> $WORKDIR/postproc
echo "#SBATCH --exclude=${excluded_nodes}"           >> $WORKDIR/postproc 
echo "WORKDIR=${WORKDIR}"                            >> $WORKDIR/postproc
cat $vini_dir/create_SLEM_named_list                 >> $WORKDIR/postproc
chmod u+x $WORKDIR/postproc
$job_submit $WORKDIR/postproc
sh $vini_dir/wait_until_jobs_finish

if [ $therapy_level -ne $ONES ] ; then  
   echo "Creating SLEM wings list, please wait."
   echo "#!/bin/bash"                                 > $WORKDIR/postproc
   echo "#SBATCH --time="$walltime                   >> $WORKDIR/postproc
   echo "#SBATCH --cpus-per-task=1"                  >> $WORKDIR/postproc
   echo "#SBATCH --mem=4gb"                          >> $WORKDIR/postproc
   echo "#SBATCH --partition="$partition             >> $WORKDIR/postproc
   echo "#SBATCH --job-name=SLEM_${lig_index}"       >> $WORKDIR/postproc
   echo "#SBATCH --account=$SLURMACCT"               >> $WORKDIR/postproc
   echo "#SBATCH --output=$WORKDIR/postproc3.out"    >> $WORKDIR/postproc
   echo "#SBATCH --error=$WORKDIR/postproc3.err"     >> $WORKDIR/postproc
   cat $vini_dir/create_SLEM_wings_list              >> $WORKDIR/postproc
   echo "#SBATCH --exclude=${excluded_nodes}"        >> $WORKDIR/postproc 
   echo "WORKDIR=${WORKDIR}"                         >> $WORKDIR/postproc
   chmod u+x postproc
   $job_submit $WORKDIR/postproc
   sh $vini_dir/wait_until_jobs_finish

   echo "Creating SLEM wings named list, please wait."
   echo "#!/bin/bash"                                 > $WORKDIR/postproc
   echo "#SBATCH --time="$walltime                   >> $WORKDIR/postproc
   echo "#SBATCH --cpus-per-task=1"                  >> $WORKDIR/postproc
   echo "#SBATCH --mem=4gb"                          >> $WORKDIR/postproc
   echo "#SBATCH --partition="$partition             >> $WORKDIR/postproc
   echo "#SBATCH --job-name=SLEM_${lig_index}"       >> $WORKDIR/postproc
   echo "#SBATCH --account=$SLURMACCT"               >> $WORKDIR/postproc
   echo "#SBATCH --output=$WORKDIR/postproc4.out"    >> $WORKDIR/postproc
   echo "#SBATCH --error=$WORKDIR/postproc4.err"     >> $WORKDIR/postproc
   cat $vini_dir/create_SLEM_wings_named_list        >> $WORKDIR/postproc
   echo "#SBATCH --exclude=${excluded_nodes}"        >> $WORKDIR/postproc 
   echo "WORKDIR=${WORKDIR}"                         >> $WORKDIR/postproc
   chmod u+x postproc
   $job_submit $WORKDIR/postproc
   sh $vini_dir/wait_until_jobs_finish
fi

echo "Done. The results are in $WORKDIR/${CANCER_PATHWAY}_results directory."
