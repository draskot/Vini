NULL=0
ONES=1
TWO=2
ORGANISM=`cat $WORKDIR/ORGANISM`                    #getting the organism type from the main script
cancer_type=`cat $WORKDIR/cancer_type`              #getting the cancer type from the main script
CANCER_PATHWAY=$ORGANISM$cancer_type                #setting the cancer pathway
therapy_level=`cat $WORKDIR/therapy_level`         #therapy level
compute_cell_line=`cat $WORKDIR/compute_cell_line`
cosmic=`cat $WORKDIR/cosmic`
cell_line=`cat cell_line`                  #getting the cell line name
job_status=`cat job_status`       
job_submit=`cat job_submit`
exhaustiveness=`cat $WORKDIR/exhaustiveness`
box_size=`cat $WORKDIR/box_size`
random_affinity=`cat $WORKDIR/random_affinity`
max_jobs=`cat $WORKDIR/max_jobs` #maximum number of Vina jobs
MAX_NODES=`cat $WORKDIR/nodes`       #maximum number of compute nodes Vini can use concurrently
partition=`cat cpu_partition`
walltime=`sinfo | grep $partition | head -1 | awk '{print $3}'` #By default we are running Vini jobs on cpu nodes
excluded_nodes=`cat excluded_${partition}_nodes`
complexes=`wc -l < $WORKDIR/receptors_contracted`
ligands=`wc -l < $vini_dir/ligands/ligands_list`
lig_source=$WORKDIR/ligands

mkdir -p $WORKDIR/${CANCER_PATHWAY}_results #Create directory for results
cd $WORKDIR

L1=1; L2=1; L3=1; L4=1;                 #Initializing main loops
case $therapy_level in                  
     1) L4=$ligands ;;
     2) L3=$ligands; L4=$ligands ;;
     3) L2=$ligands; L3=$ligands; L4=$ligands ;;
     4) L1=$ligands; L2=$ligands; L3=$ligands; L4=$ligands ;;
esac

state=`cat $vini_dir/state`                 #setting loop control parameters
dir=$WORKDIR/${cancer_type}_data 
if  [ $state == crash ]
then
    ligand_number=`grep ligand_number $WORKDIR/restartfile | awk '{print $2}'`
    Kappa=`grep          I         $WORKDIR/restartfile | awk '{print $2}'`
    Lambda=`grep         J         $WORKDIR/restartfile | awk '{print $2}'`
    Mu=`grep             L         $WORKDIR/restartfile | awk '{print $2}'`
    Nu=`grep             M         $WORKDIR/restartfile | awk '{print $2}'`
    Xi=$ONES
    echo "deleting SLEM values after the last checkpoint"
    MaxSLEMvalues=`echo ${Kappa} ${Lambda} ${Mu} ${Nu} ${Xi} ${ligands} | awk '{print $1 * $2 * $3 * $4 * $5 * $6 }'`
    NoSLEMvalues=`echo ${Kappa} ${Lambda} ${Mu} ${Nu} ${Xi} ${ligand_number} | awk '{print $1 * $2 * $3 * $4 * $5 * $6 }'`
    Delete=`echo $MaxSLEMvalues $NoSLEMvalues $ONES | awk '{print $1 - $2 - $3}'`
    head -$Delete $vini_dir/ligands/ligands_list > $WORKDIR/tmp
    mv $WORKDIR/tmp $WORKDIR/SLEM_values
else
    ligand_number=1                #initializing ligand index
    Kappa=$ONES
    Lambda=$ONES
    Mu=$ONES
    Nu=$ONES
    Xi=$ONES
    > $WORKDIR/SLEM_values    #delete SLEM values from the previous run
fi
 
SECONDS=$NULL

echo "Calculating free binding energies for therapy level ${therapy_level}. This may take a while, please be patient."


for (( I=$((Kappa)); I<$((L1+1)); I++ )) #1st loop - 4th therapy level
do
    for (( J=$((Lambda)); J<$((L2+1)); J++ )) #2nd loop -3rd therapy level
    do
         for (( L=$((Mu)); L<$((L3+1)); L++ )) #3rd loop -2nd thl
         do
             for (( M=$((Nu)); M<$((L4+1)); M++ )) #4th loop - 1st thl
             do
                 printf -v lig_index "%03d" $M  
                 case $therapy_level in
                     1) comp_source=$dir;          target_dir=$dir/$M ;;
                     2) comp_source=$dir/$M;       target_dir=$dir/$M/$L ;;
                     3) comp_source=$dir/$M/$L;    target_dir=$dir/$M/$L/$J ;;
                     4) comp_source=$dir/$M/$L/$J; target_dir=$dir/$M/$L/$J/$I ;;
                 esac
                 mkdir -p $comp_source $target_dir # nr. of target dirs equals nr. of ligands
                 for (( N=$((Xi)); N<$((complexes+1)); N++ )) #5th loop
       	         do
                     printf -v n "%03d" $N
                     comp_index=$n
                     conf_index=$comp_index
                     log_index=$comp_index
                     line=`head -"$ligand_number" $vini_dir/ligands/ligands_list | tail -1`
                     drug=`echo $line | awk -F',' '{print $1}'`
                     moltype=`echo $line | awk -F','  '{print $2}'`
                     mkdir -p $WORKDIR/$comp_index
                     cd $WORKDIR/$comp_index   #move to the working area
                     rm -rf *
                     if  [ ! -e $comp_source/complex_${comp_index}.pdb ]
                     then
                         echo "error" > $target_dir/log_${log_index}
                     else
                         cp $comp_source/complex_${comp_index}.pdb ./     #clean receptor
                         sed -i '$ d' complex_${comp_index}.pdb           
                         echo "END                                                                           " >> complex_${comp_index}.pdb
                         source $INSTALL/miniconda2/bin/activate
                         cp $ROSETTA_TOOLS/amino_acids.py ./
                         cp $ROSETTA_PUB/clean_pdb_keep_ligand.py ./
                         python clean_pdb_keep_ligand.py complex_${comp_index}.pdb -ignorechain
                         mv complex_${comp_index}.pdb_00.pdb complex_${comp_index}.pdb
                         conda deactivate
                         echo "#!/bin/bash"                                                                    > dock
                         echo "#SBATCH --time=$walltime"                                                      >> dock
                         echo "#SBATCH --account=$SLURMACCT"                                                  >> dock
                         echo "#SBATCH --partition=$partition"                                                >> dock
                         echo "#SBATCH --nodes=1"                                                             >> dock
                         echo "#SBATCH --ntasks=1"                                                            >> dock
                         echo "#SBATCH --cpus-per-task=48"                                                    >> dock
                         echo "#SBATCH --job-name=Rozy_${M}_${N}"                                             >> dock
                         echo "#SBATCH --output=${target_dir}/Rozy_${M}_${N}.out"                             >> dock
                         echo "#SBATCH --error=${target_dir}/Rozy_${M}_${N}.err"                              >> dock
                         if  [ $moltype == S ]
                         then
                             cp $vini_dir/ligands/sdf_files/${drug}.sdf ./ligand_${lig_index}.sdf  #prepare ligand
                             python $ROSETTA/source/scripts/python/public/molfile_to_params.py -n LIG -p LIG --clobber ligand_${lig_index}.sdf
                             mv LIG_0001.pdb ligand_${lig_index}.pdb
                             rm ligand_${lig_index}.sdf
                             cp $vini_dir/docking.mac ./
                             cp complex_${comp_index}.pdb receptor.pdb
                             cp ligand_${lig_index}.pdb ligand.pdb
                             hex -batch receptor.pdb ligand.pdb < docking.mac > docking.log
                             grep -v REMARK complex.pdb > tmp ; mv tmp crystal_complex.pdb
                             rm receptor.pdb ligand.pdb docking.log docking.mac
                             cat complex_${comp_index}.pdb ligand_${lig_index}.pdb > complex_${comp_index}_LIG.pdb
                             cp $vini_dir/flag_ligand_docking ./
                             cp $vini_dir/dock.xml ./
                             echo "ligand_dock.cxx11thread.linuxgccrelease -in:file:s complex_${comp_index}_LIG.pdb -multithreading:total_threads 48 @flag_ligand_docking"                                                                                          >> dock
                             echo "if [ -e ROSETTA_CRASH.log ] ; then"                                               >> dock
                             echo "echo "error" > $target_dir/log_${log_index}"                                      >> dock
                             echo "else"                                                                             >> dock
                             echo "awk '/END_POSE/ { found=1 } !found { print } found { exit }' silent.out > tmp"    >> dock
                             echo "grep -e ATOM -e HETATM tmp > $target_dir/complex_${comp_index}.pdb"               >> dock
                             echo "grep -m 1 -w pose silent.out | awk '{print  \$2}' > $target_dir/log_${log_index}" >> dock
                             echo "fi"                                                                               >> dock
                         else              
                             cp $WORKDIR/ligands/ligand_${lig_index}.pdb ./
                             fasta_file=${vini_dir}/ligands/fasta_files/${drug}.fasta #set chains ID in ligand
                             chains=`grep -c ">" ${fasta_file}`     
                             if  [ $chains -eq $ONES ]
                             then
                                 java -jar $vini_dir/PDBChainNameSupstitutor-1.0-SNAPSHOT-shaded.jar ligand_${lig_index}.pdb A B
                                 mv ligand_${lig_index}.pdb_A_to_B.pdb ligand_${lig_index}.pdb
                             else
                                 java -jar $vini_dir/PDBChainNameSupstitutor-1.0-SNAPSHOT-shaded.jar ligand_${lig_index}.pdb B C
                                 java -jar $vini_dir/PDBChainNameSupstitutor-1.0-SNAPSHOT-shaded.jar ligand_${lig_index}.pdb_B_to_C.pdb A B
                                 mv ligand_${lig_index}.pdb_B_to_C.pdb_A_to_B.pdb ligand_${lig_index}.pdb
                             fi
                             sh $vini_dir/jobs_control_script ${job_status} ${max_jobs}
                             cp $vini_dir/flag_input_relax $vini_dir/flag_global_docking $vini_dir/docking.mac ./
                             cp complex_${comp_index}.pdb receptor.pdb   #generate complex with Hex
                             cp ligand_${lig_index}.pdb ligand.pdb
                             hex -batch receptor.pdb ligand.pdb < docking.mac > docking.log 
                             cp complex.pdb complex_${comp_index}.pdb
                             echo "relax.cxx11thread.linuxgccrelease -in:file:s complex_${comp_index}.pdb -multithreading:total_threads 48 @flag_input_relax"                                                            >> dock
                             echo "docking_protocol.cxx11thread.linuxgccrelease -in:file:s complex_${comp_index}_0002.pdb -multithreading:total_threads 48 @flag_global_docking"                                         >> dock
                             echo "if [ -e ROSETTA_CRASH.log ] ; then"                >> dock
                             echo "echo "error" > $target_dir/log_${log_index}"       >> dock
                             echo "else"                                              >> dock
                             echo "cp complex_${comp_index}_0002_0001.pdb $target_dir/complex_${comp_index}.pdb" >> dock
                             echo "grep complex_${comp_index}_0002_0001 score.sc | awk '{print  \$2}' > $target_dir/log_${log_index}" >> dock
                             echo "fi"                                                >> dock
                         fi
                     fi
                     chmod u+x                                                   dock         
                     sh $vini_dir/jobs_control_script ${job_status} ${max_jobs}
                     ${job_submit}                                               dock
                     sh $vini_dir/write_checkpoint ${ligand_number} ${I} ${J} ${L} ${M}    #write restart point
    	         done # end of 5th loop
                 
                 cd $WORKDIR

                 sh $vini_dir/wait_until_jobs_finish


                 #echo "Creating binding energy vector, please wait."
                 #rm -f ${target_dir}/vec*
                 #echo "#!/bin/bash"                                          > ${target_dir}/vec_${lig_index}
                 #echo "#SBATCH --time="$walltime                            >> ${target_dir}/vec_${lig_index}
                 #echo "#SBATCH --cpus-per-task=1"                           >> ${target_dir}/vec_${lig_index}
                 #echo "#SBATCH --mem=4gb"                                   >> ${target_dir}/vec_${lig_index}
                 #echo "#SBATCH --partition="$partition                      >> ${target_dir}/vec_${lig_index}
                 #echo "#SBATCH --job-name=vec_${lig_index}"                 >> ${target_dir}/vec_${lig_index}
                 #echo "#SBATCH --account=$SLURMACCT"                        >> ${target_dir}/vec_${lig_index}
                 #echo "#SBATCH --output=${target_dir}/vec_${lig_index}.out" >> ${target_dir}/vec_${lig_index}
                 #echo "#SBATCH --output=${target_dir}/vec_${lig_index}.err" >> ${target_dir}/vec_${lig_index}
                 #echo "#SBATCH --exclude=${excluded_nodes}"                 >> ${target_dir}/vec_${lig_index} 
                 #cat $vini_dir/create_vector                                >> ${target_dir}/vec_${lig_index}
                 #chmod u+x ${target_dir}/vec_${lig_index}
                 #${job_submit} ${target_dir}/vec_${lig_index} ${target_dir} ${WORKDIR}
                 #sh $vini_dir/wait_until_jobs_finish
                 

                 echo "Creating binding energy matrix, please wait."
                 echo ${target_dir} > target_dir
                 echo "#!/bin/bash"                                          > ${target_dir}/mat_${lig_index}
                 echo "#SBATCH --time="$walltime                            >> ${target_dir}/mat_${lig_index}
                 echo "#SBATCH --cpus-per-task=1"                           >> ${target_dir}/mat_${lig_index}
                 echo "#SBATCH --mem=4gb"                                   >> ${target_dir}/mat_${lig_index}
                 echo "#SBATCH --partition="$partition                      >> ${target_dir}/mat_${lig_index}
                 echo "#SBATCH --job-name=mat_${lig_index}"                 >> ${target_dir}/mat_${lig_index}
                 echo "#SBATCH --account=$SLURMACCT"                        >> ${target_dir}/mat_${lig_index}
                 echo "#SBATCH --output=${target_dir}/mat_${lig_index}.out" >> ${target_dir}/mat_${lig_index}
                 echo "#SBATCH --error=${target_dir}/mat_${lig_index}.err"  >> ${target_dir}/mat_${lig_index}
                 echo "#SBATCH --exclude=${excluded_nodes}"                 >> ${target_dir}/mat_${lig_index} 
                 echo "WORKDIR=${WORKDIR}"                                  >> ${target_dir}/mat_${lig_index}
                 echo "source $INSTALL/miniconda3/bin/activate"             >> ${target_dir}/mat_${lig_index}
                 echo "conda activate env310"                               >> ${target_dir}/mat_${lig_index}
                 echo "python3 $vini_dir/create_energy_binding_matrix.py"   >> ${target_dir}/mat_${lig_index}
                 echo "conda deactivate"                                    >> ${target_dir}/mat_${lig_index}
                 chmod u+x ${target_dir}/mat_${lig_index}
                 ${job_submit} ${target_dir}/mat_${lig_index}
                 sh $vini_dir/wait_until_jobs_finish

                 echo "Calculating eigenvalues, please wait."
                 echo ${target_dir} > target_dir
                 echo "#!/bin/bash"                                            > ${target_dir}/eigen_${lig_index}
                 echo "#SBATCH --time="$walltime                              >> ${target_dir}/eigen_${lig_index}
                 echo "#SBATCH --cpus-per-task=1"                             >> ${target_dir}/eigen_${lig_index}
                 echo "#SBATCH --mem=4gb"                                     >> ${target_dir}/eigen_${lig_index}
                 echo "#SBATCH --partition="$partition                        >> ${target_dir}/eigen_${lig_index}
                 echo "#SBATCH --job-name=eigen_${lig_index}"                 >> ${target_dir}/eigen_${lig_index}
                 echo "#SBATCH --account=$SLURMACCT"                          >> ${target_dir}/eigen_${lig_index}
                 echo "#SBATCH --output=${target_dir}/eigen_${lig_index}.out" >> ${target_dir}/eigen_${lig_index}
                 echo "#SBATCH --error=${target_dir}/eigen_${lig_index}.err"  >> ${target_dir}/eigen_${lig_index}
                 echo "#SBATCH --exclude=${excluded_nodes}"                   >> ${target_dir}/eigen_${lig_index} 
                 echo "WORKDIR=${WORKDIR}"                                    >> ${target_dir}/eigen_${lig_index}
                 echo "source $INSTALL/miniconda3/bin/activate"               >> ${target_dir}/eigen_${lig_index}
                 echo "conda activate env310"                                 >> ${target_dir}/eigen_${lig_index}
                 echo "python3 $vini_dir/compute_eigenvalues.py -s $target_dir/EB_matrix -t $target_dir/E_Vina" >> ${target_dir}/eigen_${lig_index}
                 echo "conda deactivate"                                      >> ${target_dir}/eigen_${lig_index}
                 chmod u+x ${target_dir}/eigen_${lig_index}
                 ${job_submit} ${target_dir}/eigen_${lig_index}
                 sh $vini_dir/wait_until_jobs_finish

                 echo "Calculating SLEM, please wait."
                 echo "#!/bin/bash"                                           > ${target_dir}/select_${lig_index}
                 echo "#SBATCH --time="$walltime                             >> ${target_dir}/select_${lig_index}
                 echo "#SBATCH --cpus-per-task=1"                            >> ${target_dir}/select_${lig_index}
                 echo "#SBATCH --mem=4gb"                                    >> ${target_dir}/select_${lig_index}
                 echo "#SBATCH --partition="$partition                       >> ${target_dir}/select_${lig_index}
                 echo "#SBATCH --job-name=SLEM_${lig_index}"                 >> ${target_dir}/select_${lig_index}
                 echo "#SBATCH --account=$SLURMACCT"                         >> ${target_dir}/select_${lig_index}
                 echo "#SBATCH --output=${target_dir}/SLEM_${lig_index}.out" >> ${target_dir}/select_${lig_index}
                 echo "#SBATCH --error=${target_dir}/SLEM_${lig_index}.err"  >> ${target_dir}/select_${lig_index}
                 echo "#SBATCH --exclude=${excluded_nodes}"                  >> ${target_dir}/select_${lig_index} 
                 echo "WORKDIR=${WORKDIR}"                                   >> ${target_dir}/select_${lig_index}
                 cat $vini_dir/select_SLEM_value                             >> ${target_dir}/select_${lig_index}
                 chmod u+x ${target_dir}/select_${lig_index}
                 ${job_submit} ${target_dir}/select_${lig_index} ${M} ${L} ${J} ${I} ${target_dir} 
                 sh $vini_dir/wait_until_jobs_finish

                 let ligand_number++
             done   #end of 4thloop
         done       #end of 3rd loop
    done            #end of 2nd loop
done                #end of 1st loop

sh $vini_dir/wait_until_jobs_finish

if  [ $cosmic == y ] ; then
    exp=exp
else
    exp=noexp
fi

cp $WORKDIR/SLEM_values $WORKDIR/${CANCER_PATHWAY}_results/SLEM_values_${cell_line}_thl${therapy_level}_${exp}

echo "Deleting equal SLEM entries with equal indices, please wait..."
echo "#!/bin/bash"                                    > $WORKDIR/postproc
echo "#SBATCH --time="$walltime                      >> $WORKDIR/postproc
echo "#SBATCH --cpus-per-task=1"                     >> $WORKDIR/postproc
echo "#SBATCH --mem=4gb"                             >> $WORKDIR/postproc
echo "#SBATCH --partition="$partition                >> $WORKDIR/postproc
echo "#SBATCH --job-name=SLEM_${lig_index}"          >> $WORKDIR/postproc
echo "#SBATCH --account=$SLURMACCT"                  >> $WORKDIR/postproc
echo "#SBATCH --output=$WORKDIR/postproc1.out"       >> $WORKDIR/postproc
echo "#SBATCH --error=$WORKDIR/postproc1.err"        >> $WORKDIR/postproc
echo "#SBATCH --exclude=${excluded_nodes}"           >> $WORKDIR/postproc
echo "WORKDIR=${WORKDIR}"                            >> $WORKDIR/postproc
cat $vini_dir/delete_SLEM_entries_with_equal_indices >> $WORKDIR/postproc  
chmod u+x $WORKDIR/postproc
$job_submit $WORKDIR/postproc
sh $vini_dir/wait_until_jobs_finish

echo "Creating SLEM named lists, please wait."
echo "#!/bin/bash"                                    > $WORKDIR/postproc
echo "#SBATCH --time="$walltime                      >> $WORKDIR/postproc
echo "#SBATCH --cpus-per-task=1"                     >> $WORKDIR/postproc
echo "#SBATCH --mem=4gb"                             >> $WORKDIR/postproc
echo "#SBATCH --partition="$partition                >> $WORKDIR/postproc
echo "#SBATCH --job-name=SLEM_${lig_index}"          >> $WORKDIR/postproc
echo "#SBATCH --account=$SLURMACCT"                  >> $WORKDIR/postproc
echo "#SBATCH --output=$WORKDIR/postproc2.out"       >> $WORKDIR/postproc
echo "#SBATCH --error=$WORKDIR/postproc2.err"        >> $WORKDIR/postproc
echo "#SBATCH --exclude=${excluded_nodes}"           >> $WORKDIR/postproc 
echo "WORKDIR=${WORKDIR}"                            >> $WORKDIR/postproc
cat $vini_dir/create_SLEM_named_list                 >> $WORKDIR/postproc
chmod u+x $WORKDIR/postproc
$job_submit $WORKDIR/postproc
sh $vini_dir/wait_until_jobs_finish

if [ $therapy_level -ne $ONES ] ; then  
   echo "Creating SLEM wings list, please wait."
   echo "#!/bin/bash"                                 > $WORKDIR/postproc
   echo "#SBATCH --time="$walltime                   >> $WORKDIR/postproc
   echo "#SBATCH --cpus-per-task=1"                  >> $WORKDIR/postproc
   echo "#SBATCH --mem=4gb"                          >> $WORKDIR/postproc
   echo "#SBATCH --partition="$partition             >> $WORKDIR/postproc
   echo "#SBATCH --job-name=SLEM_${lig_index}"       >> $WORKDIR/postproc
   echo "#SBATCH --account=$SLURMACCT"               >> $WORKDIR/postproc
   echo "#SBATCH --output=$WORKDIR/postproc3.out"    >> $WORKDIR/postproc
   echo "#SBATCH --error=$WORKDIR/postproc3.err"     >> $WORKDIR/postproc
   cat $vini_dir/create_SLEM_wings_list              >> $WORKDIR/postproc
   echo "#SBATCH --exclude=${excluded_nodes}"        >> $WORKDIR/postproc 
   echo "WORKDIR=${WORKDIR}"                         >> $WORKDIR/postproc
   chmod u+x postproc
   $job_submit $WORKDIR/postproc
   sh $vini_dir/wait_until_jobs_finish

   echo "Creating SLEM wings named list, please wait."
   echo "#!/bin/bash"                                 > $WORKDIR/postproc
   echo "#SBATCH --time="$walltime                   >> $WORKDIR/postproc
   echo "#SBATCH --cpus-per-task=1"                  >> $WORKDIR/postproc
   echo "#SBATCH --mem=4gb"                          >> $WORKDIR/postproc
   echo "#SBATCH --partition="$partition             >> $WORKDIR/postproc
   echo "#SBATCH --job-name=SLEM_${lig_index}"       >> $WORKDIR/postproc
   echo "#SBATCH --account=$SLURMACCT"               >> $WORKDIR/postproc
   echo "#SBATCH --output=$WORKDIR/postproc4.out"    >> $WORKDIR/postproc
   echo "#SBATCH --error=$WORKDIR/postproc4.err"     >> $WORKDIR/postproc
   cat $vini_dir/create_SLEM_wings_named_list        >> $WORKDIR/postproc
   echo "#SBATCH --exclude=${excluded_nodes}"        >> $WORKDIR/postproc 
   echo "WORKDIR=${WORKDIR}"                         >> $WORKDIR/postproc
   chmod u+x postproc
   $job_submit $WORKDIR/postproc
   sh $vini_dir/wait_until_jobs_finish
fi

echo "Done. The results are in $WORKDIR/${CANCER_PATHWAY}_results directory."
