
pdb=.pdb
pdbqt=.pdbqt
job_status=`cat $WORKDIR/job_status`
job_submit=`cat $WORKDIR/job_submit`
max_jobs=`cat $WORKDIR/max_jobs`
na="NA"

rm -f ligands_contracted

echo "yes" > $WORKDIR/success

echo -n "Please wait while creating ligand pdbqt files..."

lineno=1
for j in $WORKDIR/ligand_*.pdb
do
    line=`head -"$lineno" $vini_dir/ligands/ligands_list | tail -1`
    process=`echo $line | cut -c1`
    flag=`echo $line | awk -F',' '{print $2}'`
    if [ $process != "#" ] && [ $flag == S ] #process drug if not commented and small molecule
    then
        b=`basename $j .pdb`
        cat Vina > Vina_run
        echo "$MGLBIN/pythonsh $MGLTOOLS/Utilities24/prepare_ligand4.py -l $WORKDIR/$b.pdb -o $WORKDIR/$b.pdbqt"  >> Vina_run
        chmod +x Vina_run
        $job_submit Vina_run
    fi
    let "lineno++"
    sh $vini_dir/jobs_control_script ${job_status} ${max_jobs}
done

lineno=1
for j in $WORKDIR/ligand_*.pdb  #final check
do
    line=`head -"$lineno" $WORKDIR/ligands_list | tail -1`
    process=`echo $line | cut -c1`
    if [ $process != "#" ]               #check if drug entry is not commented
    then
        flag=`echo $line | awk -F','  '{print $2}'`
        b=`basename $j .pdb`
        if  [[ ! -e $WORKDIR/$b$pdbqt ]] && [[ $flag == S ]] #delete drug if pdbqt creation failed 
        then
            ligand=`echo $line | awk -F','  '{print $1}'`
            echo "Warning! pdbqt file for" $ligand "was not created! Drug will be not processed."
            awk -v "lineno=$lineno"  'NR==lineno { $0 = "#" $0 }; 1' $vini_dir/ligands/ligands_list > tmp
            mv tmp $vini_dir/ligands/ligands_list
        fi
        let "lineno++"
    fi
done

grep -v "#" $vini_dir/ligands/ligands_list > tmp #Not analysing commented entries
mv tmp $vini_dir/ligands/ligands_list

echo "done."

rm -f $WORKDIR/slurm* $WORKDIR/*.job #cleanup
