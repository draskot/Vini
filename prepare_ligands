TRUE=1
FALSE=0
job_status=`cat $WORKDIR/job_status`
job_submit=`cat $WORKDIR/job_submit`
max_jobs=`cat $WORKDIR/max_jobs`
partition=`cat $WORKDIR/cpu_partition`
excluded_nodes=`cat $WORKDIR/excluded_${partition}_nodes`
walltime=`cat $WORKDIR/walltime`

echo "Preparing ligand pdbqt files, please wait..."

cd $WORKDIR
i=1
while  read -r line
do
    printf -v lig_index "%03d" $i
    echo -n "."
    drugname=`echo $line | awk -F',' '{print $1}'`
    flag=`echo $line | awk -F',' '{print $2}'`

    if  [ -e $vini_dir/ligands/pdbqt_files/${drugname}.pdbqt ]
    then
        cp $vini_dir/ligands/pdbqt_files/${drugname}.pdbqt $WORKDIR/ligand_${lig_index}.pdbqt #pdbqt is in repo
    else                                                                  #create pdbqt file
        cp $vini_dir/ligands/pdb_files/${drugname}.pdb $WORKDIR #create pdbqt file
        echo "#!/bin/bash"                               > preplig
        echo "#SBATCH --time=$walltime"                 >> preplig
        echo "#SBATCH --job-name=$drugname"             >> preplig
        echo "#SBATCH --account=$SLURMACCT"             >> preplig
        echo "#SBATCH --cpus-per-task=2"                >> preplig
        echo "#SBATCH --mem=4gb"                        >> preplig
        echo "#SBATCH --partition=cpu"                  >> preplig
        echo "#SBATCH --partition="$partition           >> preplig
        echo "#SBATCH --output=$WORKDIR/$drugname.out"  >> preplig
        echo "#SBATCH --error=$WORKDIR/$drugname.err"   >> preplig
        echo "#SBATCH --exclude=${excluded_nodes}"      >> preplig
        echo "$MGLBIN/pythonsh $MGLTOOLS/Utilities24/prepare_ligand4.py -l $vini_dir/ligands/pdb_files/${drugname}.pdb -o $WORKDIR/ligand_${lig_index}.pdbqt"                  >> preplig
        chmod u+x preplig
        sh $vini_dir/jobs_control_script ${job_status} ${max_jobs}
        $job_submit preplig
    fi
    cp $vini_dir/ligands/pdb_files/${drugname}.pdb $WORKDIR/ligand_${lig_index}.pdb #for Rosetta
    let i++
done < $vini_dir/ligands/ligands_list

sh $vini_dir/wait_until_jobs_finish #wait until all jobs finish

echo -n "Checking if pdbqt files are created..."
> $WORKDIR/tmp
while read -r line  
do
    echo -n "."
    drugname=`echo $line | awk -F',' '{print $1}'`
    echo $drugname > drugname ; words=`wc -w < drugname`
    if  [ $words -eq 2 ] ; then #put ? between 2 words
        word1=`echo $drugname | awk '{print $1}'` ;  word2=`echo $drugname | awk '{print $2}'`
        drugname=`echo $word1"?"$word2`
    fi
    flag=`echo $line | awk -F',' '{print $2}'`
    if  [[ ! -e $WORKDIR/${drugname}.pdbqt ]] && [[ $flag == S ]] #delete drug if pdbqt creation failed
    then
        echo "pdbqt file for" $drugname "was not created!" $drugname "will not be analyzed."
    else
        echo $line >> $WORKDIR/tmp
    fi
done < $vini_dir/ligands/ligands_list
rm -f *out *err
mv $WORKDIR/tmp $vini_dir/ligands/ligands_list
echo "done."
