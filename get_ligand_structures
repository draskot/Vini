#This script looks for 3D ligands structures.
#If no 3D (SDF) structure on RCSB is found, we search for it on Drugbank.
#If no 3D (SDF) structure on Drugbank is found, we search for pdb structure on Drugbank.
#If found, we convert this structure to 3D (SDF) with Openbabel. Otherwise, we delete this drug from ligands_list.
#Input param: structure type on RCSB (can be "model" or "ideal")
 
structure_type=$1
NULL=0


#rm -rf $vini_dir/database/ligands/sdf_files/*       #cleanup
#rm -rf $vini_dir/database/ligands/pdb_files/*       #cleanup
#rm -rf $vini_dir/database/ligands/pdbqt_files/*     #cleanup

prefix=https://files.rcsb.org/ligands/view/
suffix=_${structure_type}.sdf

while read -r line
do
    drug=`echo $line | awk -F','  '{print $1}'`
    if [ ! -e $vini_dir/database/ligands/sdf_files/${drug}.sdf ]
    then
        echo -n "trying to download ${drug}.3d-sdf $structure_type structure from RCSB..."
        rcsb_code=`echo $line | awk -F','  '{print $4}'`
        if [ $rcsb_code == NA ]
        then
            echo "not exists on RCSB."
        else
            wget -q -O $vini_dir/database/ligands/sdf_files/${drug}.sdf $prefix${rcsb_code}$suffix
        fi
        if  [ -e $vini_dir/database/ligands/sdf_files/${drug}.sdf ]
        then
            echo "done."
        else
            echo "not exists in repo."
            echo -n "trying to download ${drug}.3D-sdf structure from Drugbank..."
            echo "grep -w" "\"$drug\"" "$vini_dir/drug?links.csv" > $WORKDIR/search  #get Drugbank ID
            sh $WORKDIR/search > $WORKDIR/tmp
            inlines=`wc -l < $WORKDIR/tmp`
            if  [ $inlines -gt $NULL ]
            then
                inline=`head -1 $WORKDIR/tmp`
                DBID=`echo $inline | tr "," " " | awk '{print $1}'`
                wget -q -O $vini_dir/database/ligands/sdf_files/${drug}.sdf https://www.drugbank.ca/structures/small_molecule_drugs/${DBID}.sdf?type=3d
                if  [ -e $vini_dir/database/ligands/sdf_files/${drug}.sdf ]
                then
                    echo "done."
                else
                    echo "failed."
                    echo -n "trying to download ${drug}.2D-SDF structure from Drugbank..."
                    wget -q -O $vini_dir/database/ligands/sdf_files/${drug}.sdf https://www.drugbank.ca/structures/small_molecule_drugs/${DBID}.sdf
                    if [ -e $vini_dir/database/ligands/sdf_files/${drug}.sdf ]
                    then
                        echo "done."
                    else
                        echo  "failed."
                        echo -n "trying to download ${drug}.pdb structure from Drugbank..."
                        wget -q -O $vini_dir/database/ligands/pdb_files/${drug}.pdb https://www.drugbank.ca/structures/small_molecule_drugs/${DBID}.pdb
                        if  [ -e $vini_dir/database/ligands/sdf_files/${drug}.pdb ]
                        then
                            echo  -n "done. Trying to convert pdb to sdf file with Openbabel..."
                            obabel -ipdb $vini_dir/database/ligands/pdb_files/${drug}.pdb -O $vini_dir/database/ligands/sdf_files/${drug}.sdf 2> /dev/null
                            if  [ -e $vini_dir/database/ligands/sdf_files/${drug}.sdf ]
                            then
                                echo "done."
                            else
                                echo "failed."
                            fi
                        else
                            echo "failed."
                        fi
                    fi
                fi
            else
                echo $drug "not found in Drugbank."
            fi
        fi
    else
        echo ${drug}.sdf "file found in repo."
    fi
done < $vini_dir/database/ligands/ligands_list
