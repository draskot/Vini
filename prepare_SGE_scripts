cluster=`uname -n`

if [ -e $WORKDIR/Vina_queue ]
then
    Vina_queue=`cat $WORKDIR/Vina_queue` 
    Vina_pe=`cat $WORKDIR/Vina_pe`
    Gromacs_queue=`cat $WORKDIR/Gromacs_queue` 
    Gromacs_pe=`cat $WORKDIR/Gromacs_pe` 
    g_mmpbsa_queue=`cat $WORKDIR/g_mmpbsa_queue` 
    g_mmpbsa_pe=`cat $WORKDIR/g_mmpbsa_pe` 
    echo "The current mapping of Vini tasks on" $cluster "partitions is:"
    echo "Vina_queue:" $Vina_queue "Gromacs_queue:" $Gromacs_queue "g_mmpbsa_queue:" $g_mmpbsa_queue
else
    echo "no mapping of my jobs on" $cluster "You will need to set it up now."  
    echo "" ; echo "Available queues on" $cluster "are:"
    qconf -sql
    read -p  "enter the name of queue Vina will use:" Vina_queue
    echo $Vina_queue > $WORKDIR/Vina_queue
    read -p  "enter the name of queue Gromacs  will use:" Gromacs_queue
    echo $Gromacs_queue > $WORKDIR/Gromacs_queue
    read -p  "enter the name of queue g_mmpbsa will use:" g_mmpbsa_queue
    echo $g_mmpbsa_queue > $WORKDIR/g_mmpbsa_queue

    echo "" ; echo "Available parallel environments on" $cluster "are:"
    qconf -spl
    read -p  "enter the name of parallel environment Vina will use:" Vina_pe
    echo $Vina_pe > $WORKDIR/Vina_pe
    read -p  "enter the name of parallel environment Gromacs  will use:" Gromacs_pe
    echo $Gromacs_pe > $WORKDIR/Gromacs_pe
    read -p  "enter the name of parallel environment g_mmpbsa will use:" g_mmpbsa_pe
    echo $g_mmpbsa_pe > $WORKDIR/g_mmpbsa_pe
fi


read -p "accept the current mapping (y/n)?" yesno
if  [ $yesno == "n" ]
then
    echo "" ; echo "Available queues on" $cluster "are:"
    qconf -sql
    read -p  "enter the name of queue Vina will use:" Vina_queue
    echo $Vina_queue > $WORKDIR/Vina_queue
    read -p  "enter the name of queue Gromacs  will use:" Gromacs_queue
    echo $Gromacs_queue > $WORKDIR/Gromacs_queue
    read -p  "enter the name of queue g_mmpbsa will use:" g_mmpbsa_queue
    echo $g_mmpbsa_queue > $WORKDIR/g_mmpbsa_queue

    echo "" ; echo "Available parallel environments on" $cluster "are:"
    qconf -spl
    read -p  "enter the name of parallel environment Vina will use:" Vina_pe
    echo $Vina_pe > $WORKDIR/Vina_pe 
    #read -p "enter the number of slots each Vina job will use:" Vina_slots
    #echo $Vina_slots > $WORKDIR/Vina_slots
    read -p  "enter the name of parallel environment Gromacs  will use:" Gromacs_pe
    echo $Gromacs_pe > $WORKDIR/Gromacs_pe
    read -p  "enter the name of parallel environment g_mmpbsa will use:" g_mmpbsa_pe
    echo $g_mmpbsa_pe > $WORKDIR/g_mmpbsa_pe
fi
sleep 2

echo ""
echo "Vina, Gromacs and g_mmpbsa jobs can use several OMP threads on compute nodes."  
echo "If you already used Vini on this system, you may use the number of threads from the previous Vini run."
echo "Alternativelly, you may enter new values."  

if  [ -e $WORKDIR/Vina_threads ] ; then
    Vina_threads=`cat $WORKDIR/Vina_threads`
    echo "The number of Vina threads is currently set to" $Vina_threads
    read -p "accept or change (a/c)?" yesno
    if [ $yesno == c ] ; then 
       read -p "Please enter the number of threads each Vina job will use:" Vina_threads
       echo $Vina_threads > $WORKDIR/Vina_threads
    fi
else
    read -p "Please enter the number of threads each Vina job will use:" Vina_threads
    echo $Vina_threads > $WORKDIR/Vina_threads
fi

if  [ -e $WORKDIR/Gromacs_threads ] ; then
    Gromacs_threads=`cat $WORKDIR/Gromacs_threads`
    echo "The number of Gromacs threads is currently set to" $Gromacs_threads
    read -p "accept or change (a/c)?" yesno
    if [ $yesno == c ] ; then 
       read -p "Please enter the number of threads each Gromacs job will use:" Gromacs_threads
       echo $Gromacs_threads > $WORKDIR/Gromacs_threads
    fi
else
    read -p "Please enter the number of threads each Gromacs job will use:" Gromacs_threads
    echo $Gromacs_threads > $WORKDIR/Gromacs_threads
fi

if  [ -e $WORKDIR/g_mmpbsa_threads ] ; then
    g_mmpbsa_threads=`cat $WORKDIR/g_mmpbsa_threads`
    echo "The number of g_mmpbsa_threads is currently set to" $g_mmpbsa_threads
    read -p "accept or change (a/c)?" yesno
    if [ $yesno == c ] ; then 
       read -p "Please enter the number of threads each g_mmpbsa job will use:" g_mmpbsa_threads
       echo $g_mmpbsa_threads > $WORKDIR/g_mmpbsa_threads
    fi
else
    read -p "Please enter the number of threads each g_mmpbsa job will use:" g_mmpbsa_threads
    echo $g_mmpbsa_threads > $WORKDIR/g_mmpbsa_threads
fi

cd $WORKDIR

echo "#! /bin/bash"                              > Vina #prepare Vina header file
echo "#$ -N Vina"                               >> Vina
echo "#$ -cwd"                                  >> Vina
echo "#$ -V"                                    >> Vina
echo "#$ -o Vina.out"                           >> Vina
echo "#$ -e Vina.out"                           >> Vina
echo "#$ -l h_rt=1800"                          >> Vina
echo "#$ -pe" $Vina_pe $Vina_threads            >> Vina
echo "#$ -l mem_free=2048"                      >> Vina
echo "#$ -q" $Vina_queue                        >> Vina
echo "WORKDIR=$WORKDIR"                         >> Vina
#echo "cd \$TMPDIR"                              >> Vina

echo "#! /bin/bash"                              > MD_prepare #prepare Gromacs header files
echo "#$ -N MD_prepare"                         >> MD_prepare
echo "#$ -cwd"                                  >> MD_prepare
echo "#$ -V"                                    >> MD_prepare
echo "#$ -o MD_prepare.out"                     >> MD_prepare
echo "#$ -e MD_prepare.out"                     >> MD_prepare
echo "#$ -l h_rt=86400"                         >> MD_prepare
echo "#$ -pe" $Gromacs_pe $Gromacs_threads      >> MD_prepare
echo "#$ -l mem_free=8192"                      >> MD_prepare
echo "#$ -q" $Gromacs_queue                     >> MD_prepare
echo "WORKDIR=$WORKDIR"                         >> MD_prepare
echo "module load gromacs/5.1.4"                >> MD_prepare
cat $vini_dir/MD_prepare_script                 >> MD_prepare
chmod u+x MD_prepare

echo "#! /bin/bash"                              > MD_run
echo "#$ -N MD_run"                             >> MD_run
echo "#$ -cwd"                                  >> MD_run
echo "#$ -V"                                    >> MD_run
echo "#$ -o MD_run.out"                         >> MD_run
echo "#$ -e MD_run.out"                         >> MD_run
echo "#$ -l h_rt=86400"                         >> MD_run
echo "#$ -pe" $Gromacs_pe $Gromacs_threads      >> MD_run
echo "#$ -l mem_free=32768"                     >> MD_run
echo "#$ -q" $Gromacs_queue                     >> MD_run
echo "WORKDIR=$WORKDIR"                         >> MD_run
echo "module load gromacs/5.1.4"                >> MD_run
cat $vini_dir/MD_run_script                     >> MD_run
chmod u+x MD_run

echo "#! /bin/bash"                              > create_index_file
echo "#$ -N ndx"                                >> create_index_file
echo "#$ -cwd"                                  >> create_index_file
echo "#$ -V"                                    >> create_index_file
echo "#$ -o ndx.out"                            >> create_index_file
echo "#$ -e ndx.out"                            >> create_index_file
echo "#$ -l h_rt=86400"                         >> create_index_file
echo "#$ -pe" $Gromacs_pe $Gromacs_threads      >> create_index_file
echo "#$ -l mem_free=4096"                      >> create_index_file
echo "#$ -q" $Gromacs_queue                     >> create_index_file
echo "WORKDIR=$WORKDIR"                         >> create_index_file
echo "module load gromacs/5.1.4"                >> create_index_file
cat $vini_dir/create_index_file_script          >> create_index_file
chmod u+x create_index_file

echo "#! /bin/bash"                              > g_mmpbsa_potential_energy  
echo "#$ -N potential"                          >> g_mmpbsa_potential_energy
echo "#$ -cwd"                                  >> g_mmpbsa_potential_energy
echo "#$ -V"                                    >> g_mmpbsa_potential_energy
echo "#$ -o potential.out"                      >> g_mmpbsa_potential_energy
echo "#$ -e potential.out"                      >> g_mmpbsa_potential_energy
echo "#$ -l h_rt=86400"                         >> g_mmpbsa_potential_energy
echo "#$ -pe" $g_mmpbsa_pe $g_mmpbsa_threads    >> g_mmpbsa_potential_energy
echo "#$ -l mem_free=16384"                     >> g_mmpbsa_potential_energy
echo "#$ -q" $g_mmpbsa_queue                    >> g_mmpbsa_potential_energy
echo "WORKDIR=$WORKDIR"                         >> g_mmpbsa_potential_energy
echo "export OMP_NUM_THREADS="$g_mmpbsa_threads >> g_mmpbsa_potential_energy
cat $vini_dir/g_mmpbsa_potential_energy_script  >> g_mmpbsa_potential_energy
chmod u+x g_mmpbsa_potential_energy

echo "#! /bin/bash"                              > g_mmpbsa_apolar_energy
echo "#$ -N apolar"                             >> g_mmpbsa_apolar_energy
echo "#$ -cwd"                                  >> g_mmpbsa_apolar_energy
echo "#$ -V"                                    >> g_mmpbsa_apolar_energy
echo "#$ -o apolar.out"                         >> g_mmpbsa_apolar_energy
echo "#$ -e apolar.out"                         >> g_mmpbsa_apolar_energy
echo "#$ -l h_rt=86400"                         >> g_mmpbsa_apolar_energy
echo "#$ -pe" $g_mmpbsa_pe $g_mmpbsa_threads    >> g_mmpbsa_apolar_energy
echo "#$ -l mem_free=16384"                     >> g_mmpbsa_apolar_energy
echo "#$ -q" $g_mmpbsa_queue                    >> g_mmpbsa_apolar_energy
echo "WORKDIR=$WORKDIR"                         >> g_mmpbsa_apolar_energy
echo "export OMP_NUM_THREADS="$g_mmpbsa_threads >> g_mmpbsa_apolar_energy
cat $vini_dir/g_mmpbsa_apolar_energy_script     >> g_mmpbsa_apolar_energy
chmod u+x g_mmpbsa_apolar_energy

echo "#! /bin/bash"                              > g_mmpbsa_polar_energy
echo "#$ -N polar"                              >> g_mmpbsa_polar_energy
echo "#$ -cwd"                                  >> g_mmpbsa_polar_energy
echo "#$ -V"                                    >> g_mmpbsa_polar_energy
echo "#$ -o polar.out"                          >> g_mmpbsa_polar_energy
echo "#$ -e polar.out"                          >> g_mmpbsa_polar_energy
echo "#$ -l h_rt=86400"                         >> g_mmpbsa_polar_energy
echo "#$ -pe" $g_mmpbsa_pe $g_mmpbsa_threads    >> g_mmpbsa_polar_energy
echo "#$ -l mem_free=16384"                     >> g_mmpbsa_polar_energy
echo "#$ -q" $g_mmpbsa_queue                    >> g_mmpbsa_polar_energy
echo "WORKDIR=$WORKDIR"                         >> g_mmpbsa_polar_energy
echo "export OMP_NUM_THREADS="$g_mmpbsa_threads >> g_mmpbsa_polar_energy
cat $vini_dir/g_mmpbsa_polar_energy_script      >> g_mmpbsa_polar_energy
chmod u+x g_mmpbsa_polar_energy

echo "#! /bin/bash"                              > compute_FBE
echo "#$ -N FBE_calc"                           >> compute_FBE
echo "#$ -cwd"                                  >> compute_FBE
echo "#$ -V"                                    >> compute_FBE
echo "#$ -o FBE_calc.out"                       >> compute_FBE
echo "#$ -e FBE_calc.out"                       >> compute_FBE
echo "#$ -l h_rt=86400"                         >> compute_FBE
echo "#$ -pe" $g_mmpbsa_pe $g_mmpbsa_threads    >> compute_FBE
echo "#$ -l mem_free=4096"                      >> compute_FBE
echo "#$ -q" $g_mmpbsa_queue                    >> compute_FBE
echo "WORKDIR=$WORKDIR"                         >> compute_FBE
echo "export OMP_NUM_THREADS="$g_mmpbsa_threads >> compute_FBE
cat $vini_dir/compute_FBE_script                >> compute_FBE
chmod u+x compute_FBE
