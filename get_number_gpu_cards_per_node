node_type=$1
walltime=$2

scheduler=`cat $WORKDIR/scheduler`
version=`cat $WORKDIR/version`
job_submit=`cat $WORKDIR/job_submit`
job_cancel=`cat $WORKDIR/job_cancel`

partition=`cat $WORKDIR/gpu_partition`

rm -f $WORKDIR/gpus.*

echo "Trying to determine the number of Nvidia gpu cards per ${node_type} node. This may last up to ${walltime} seconds, do not interrupt."

echo "#! /bin/bash"                                        > $WORKDIR/get_number_gpus_per_node
echo "#SBATCH --job-name=gpus"                            >> $WORKDIR/get_number_gpus_per_node
echo "#SBATCH --output=$WORKDIR/gpus.out"                 >> $WORKDIR/get_number_gpus_per_node
echo "#SBATCH --error=$WORKDIR/gpus.err"                  >> $WORKDIR/get_number_gpus_per_node
echo "#SBATCH --time=00:00:"$walltime                     >> $WORKDIR/get_number_gpus_per_node
echo "#SBATCH --cpus-per-task=1"                          >> $WORKDIR/get_number_gpus_per_node
if  [[ ${node_type} == gpu ]] && [[ ${scheduler} == SLURM ]]
then
    if  [ $version == 20.11.9-Bull.1.1 ]
    then
        echo "#SBATCH --gres=gpu:1"                       >> $WORKDIR/get_number_gpus_per_node
    fi
fi
echo "#SBATCH --mem=2gb"                                  >> $WORKDIR/get_number_gpus_per_node
echo "#SBATCH --partition="$partition                     >> $WORKDIR/get_number_gpus_per_node
echo "lspci"                                              >> $WORKDIR/get_number_gpus_per_node
chmod u+x                                                    $WORKDIR/get_number_gpus_per_node

rm -f $WORKDIR/gpus.*

sbatch $WORKDIR/get_number_gpus_per_node

timeout ${walltime}s $vini_dir/wait_until_jobs_finish


if  [ -e $WORKDIR/gpus.out ] 
then
    grep NVIDIA gpus.out > tmp
    gpus=`wc -l < tmp`
    read -p "Found $gpus NVIDIA cards per gpu node. Accept [y] or enter the new value?" accept
    if  [ $accept != y ]
    then
        read -p "Enter the new value:" gpus
    fi
else
    ${job_cancel} -u $USER ; echo
    read -p "Failed to access any ${node_type} node. They may be busy or down. Check their status and write the number of gpu cards per ${node_type} node." gpus
fi

echo $gpus > $WORKDIR/gpus
