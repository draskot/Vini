TRUE=1
FALSE=0
job_status=`cat $WORKDIR/job_status`
job_submit=`cat $WORKDIR/job_submit`
max_jobs=`cat $WORKDIR/max_jobs`
partition=`cat $WORKDIR/cpu_partition`
excluded_nodes=`cat $WORKDIR/excluded_${partition}_nodes

cd $WORKDIR
i=1
while  read -r line
do
    printf -v lig_index "%03d" $i
    drugname=`echo $line | awk -F',' '{print $1}'`
    flag=`echo $line | awk -F',' '{print $2}'`
    if [ $flag == S ]
    then
        echo "Creating $drugname pdbqt file from 3D sdf file with meeko, please wait."
        cp $vini_dir/ligands/sdf_files/${drugname}.sdf $WORKDIR #create pdbqt file
        echo "#! /bin/bash"                                                > meeko.$i
        echo "#SBATCH --job-name=meeko"                                   >> meeko.$i
        echo "#SBATCH --account=$SLURMACCT"                               >> meeko.$i
        echo "#SBATCH --time=00:60:00"                                    >> meeko.$i
        echo "#SBATCH --output=/exa5/scratch/user/eudraskot/meeko.$i.out" >> meeko.$i
        echo "#SBATCH --error=/exa5/scratch/user/eudraskot/meeko.$i.err"  >> meeko.$i
        echo "#SBATCH --cpus-per-task=4"                                  >> meeko.$i
        echo "#SBATCH --mem=8gb"                                          >> meeko.$i
        echo "#SBATCH --partition=cpu"                                    >> meeko.$i
        echo "#SBATCH --exclude=${excluded_nodes}"                        >> meeko.$i  
        echo "WORKDIR=$WORKDIR"                                           >> meeko.$i
        echo "source $INSTALL/miniconda3/bin/activate"                    >> meeko.$i
        echo "conda activate env310"                                      >> meeko.$i
        echo "mk_prepare_ligand.py -i $vini_dir/ligands/sdf_files/${drugname}.sdf -o $WORKDIR/ligand_${lig_index}.pdbqt"                                                     >> meeko.$i
        echo "conda deactivate"                                           >> meeko.$i
        chmod u+x                                                            meeko.$i
        sh $vini_dir/jobs_control_script ${job_status} ${max_jobs}
        $job_submit meeko.$i
        let i++
    fi
done < $vini_dir/ligands/ligands_list

sh $vini_dir/wait_until_jobs_finish #wait until all jobs finish

echo -n "Checking if pdbqt files are created, do not interrupt."
> $WORKDIR/tmp
i=1
while read -r line  
do
    printf -v lig_index "%03d" $i
    drugname=`echo $line | awk -F',' '{print $1}'`
    echo $drugname > drugname ; words=`wc -w < drugname`
    if  [ $words -eq 2 ]
    then #put ? between 2 words
        word1=`echo $drugname | awk '{print $1}'` ;  word2=`echo $drugname | awk '{print $2}'`
        drugname=`echo $word1"?"$word2`
    fi
    flag=`echo $line | awk -F',' '{print $2}'`

    if  [ $flag != S ]
    then
        echo $line >> $WORKDIR/tmp
    else
        if  [[ -e $WORKDIR/ligand_${lig_index}.pdbqt ]] && [[ $flag == S ]] 
        then
            echo "pdbqt file for $drugname created."
            cp $WORKDIR/ligand_${lig_index}.pdbqt $vini_dir/ligands/pdbqt_files/${drugname}.pdbqt
        else
            echo "meeko didn't succeeded to create pdbqt file for $drugname"
            echo "Converting with open babel."
            obabel -ipdb $vini_dir/ligands/pdb_files/$drugname.pdb -opdbqt -O $WORKDIR/ligand_${lig_index}.pdbqt -p 7.4 -xr
        fi
    fi
    let i++
done < $vini_dir/ligands/ligands_list
