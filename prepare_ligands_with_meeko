TRUE=1
FALSE=0
job_status=`cat $WORKDIR/job_status`
job_submit=`cat $WORKDIR/job_submit`
max_jobs=`cat $WORKDIR/max_jobs`

cd $WORKDIR
i=1
while  read -r line
do
    printf -v lig_index "%03d" $i
    echo -n "."
    drugname=`echo $line | awk -F',' '{print $1}'`
    flag=`echo $line | awk -F',' '{print $2}'`
    if [ $flag == S ]
    then
        if  [ -e $vini_dir/ligands/pdbqt_files/${drugname}.pdbqt ]     #check if drugname.pdbqt file already exists
        then
            cp $vini_dir/ligands/pdbqt_files/${drugname}.pdbqt $WORKDIR/ligand_${lig_index}.pdbqt #pdbqt is in repo
        else                                                            
            echo "Creating $drugname pdbqt file from 3D sdf file, please wait."
            cp $vini_dir/ligands/sdf_files/${drugname}.sdf $WORKDIR #create pdbqt file
            rm -f meeko.out meeko.err

            cat $WORKDIR/meeko                                                                            > meeko_run
            if [ -e $WORKDIR/failed_nodes ]
            then
                failed_nodes=`cat $WORKDIR/failed_nodes`
                echo "#SBATCH --exclude=${failed_nodes}"   >> meeko_run  #node not working properly 
            fi
            echo "WORKDIR=$WORKDIR"                        >> meeko_run
            echo "source $INSTALL/miniconda3/bin/activate"                                               >> meeko_run
            echo "conda activate env310"                                                                 >> meeko_run
            echo "mk_prepare_ligand.py -i $vini_dir/ligands/sdf_files/${drugname}.sdf -o $WORKDIR/ligand_${lig_index}.pdbqt" >> meeko_run
            echo "if [ -e $WORKDIR/ligand_${lig_index}.pdbqt ] ; then"                                   >> meeko_run
            echo "cp $WORKDIR/ligand_${lig_index}.pdbqt $vini_dir/ligands/pdbqt_files/${drugname}.pdbqt" >> meeko_run
            echo "fi"                                                                                    >> meeko_run
            echo "conda deactivate"                                                                      >> meeko_run

            chmod u+x                                                                                       meeko_run
            sh $vini_dir/jobs_control_script ${job_status} ${max_jobs}
            $job_submit meeko_run
            echo "brakepoint" ; sleep 1000
        fi
    fi
    let i++
done < $vini_dir/ligands/ligands_list

sh $vini_dir/wait_until_jobs_finish #wait until all jobs finish


echo -n "Checking if pdbqt files are created..."
> $WORKDIR/tmp
while read -r line  
do
    echo -n "."
    drugname=`echo $line | awk -F',' '{print $1}'`
    echo $drugname > drugname ; words=`wc -w < drugname`
    if  [ $words -eq 2 ] ; then #put ? between 2 words
        word1=`echo $drugname | awk '{print $1}'` ;  word2=`echo $drugname | awk '{print $2}'`
        drugname=`echo $word1"?"$word2`
    fi
    flag=`echo $line | awk -F',' '{print $2}'`
    if  [[ ! -e $vini_dir/ligands/pdbqt_files/${drugname}.pdbqt ]] && [[ $flag == S ]] 
    then
        echo "pdbqt file for" $drugname "not created!" $drugname "will not be analyzed."
    else
        echo $line >> $WORKDIR/tmp
    fi
done < $vini_dir/ligands/ligands_list

mv $WORKDIR/tmp $vini_dir/ligands/ligands_list
echo "done."
