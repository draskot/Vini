ligand=Osimertinib                                                   #next 5 lines are for debug
target_dir=`pwd`                                 
comp_index=001
lig_index=001
cp 1AKI.orig complex_${comp_index}.pdb
M=N=1
partition=`cat $WORKDIR/cpu_partition`
walltime=`sinfo | grep $partition | head -1 | awk '{print $3}'` #By default we are running Vini jobs on cpu nodes
job_submit=`cat job_submit`

cp $vini_dir/ligands/sdf_files/${ligand}.sdf ./ligand_${lig_index}.sdf  #prepare ligand
python $ROSETTA/source/scripts/python/public/molfile_to_params.py -n LIG -p LIG --clobber ligand_${lig_index}.sdf
mv LIG_0001.pdb ligand_${lig_index}.pdb
rm ligand_${lig_index}.sdf

export PYTHONPATH=$ROSETTA/source/scripts/python/public   #prepare receptor
source $INSTALL/miniconda2/bin/activate  
python $ROSETTA_TOOLS/clean_pdb.py complex_${comp_index}.pdb A
mv complex_${comp_index}_A.pdb complex_${comp_index}.pdb
rm complex_${comp_index}_A.fasta
conda deactivate

cp $vini_dir/docking.mac ./
cp complex_${comp_index}.pdb receptor.pdb
cp ligand_${lig_index}.pdb ligand.pdb
hex -batch receptor.pdb ligand.pdb < docking.mac > docking.log
grep -v REMARK complex.pdb > tmp ; mv tmp crystal_complex.pdb

rm receptor.pdb ligand.pdb docking.log docking.mac

#bcl-apps.exe molecule:BuildConformerLibrary -ensemble ligand_${lig_index}.sdf -scaffolds ligand_${lig_index}.sdf -conformation_comparer Atom -output ligand_${lig_index}_conformers.sdf

cat complex_${comp_index}.pdb ligand_${lig_index}.pdb > complex_${comp_index}_LIG.pdb 

cp $vini_dir/flag_ligand_docking ./
#cp $ROSETTA/demos/tutorials/ligand_docking/docking/dock.xml ./
cp $vini_dir/dock.xml ./

echo "#!/bin/bash"                                        > dock
echo "#SBATCH --time=$walltime"                          >> dock
echo "#SBATCH --account=$SLURMACCT"                      >> dock
echo "#SBATCH --partition=$partition"                    >> dock
echo "#SBATCH --nodes=1"                                 >> dock
echo "#SBATCH --ntasks=1"                                >> dock
echo "#SBATCH --cpus-per-task=48"                        >> dock
echo "#SBATCH --job-name=Rozy_${M}_${N}"                 >> dock
echo "#SBATCH --output=${target_dir}/Rozy_${M}_${N}.out" >> dock
echo "#SBATCH --error=${target_dir}/Rozy_${M}_${N}.err"  >> dock
echo "ligand_dock.cxx11thread.linuxgccrelease -in:file:s complex_${comp_index}_LIG.pdb -multithreading:total_threads 48 @flag_ligand_docking"               >> dock

echo "if [ -e ROSETTA_CRASH.log ] ; then"                >> dock
echo "echo "error" > $target_dir/log_${log_index}"       >> dock
echo "else"                                              >> dock
echo "analyse silent.out file"                           >> dock
echo "grep complex_${comp_index}_0002_0001 score.sc | awk '{print  \$2}' > $target_dir/log_${log_index}" >> dock
echo "fi"                                                >> dock
chmod u+x                                                   dock      
${job_submit}                                               dock
