dots=:
pdb=.pdb
NULL=0
ONES=1

DOWNLOAD_DIR=$vini_dir/ligands/pdb_files

email=`cat $WORKDIR/Drugbank_email`
password=`cat $WORKDIR/Drugbank_password`

if [ ! -e drug?links.csv ]
then
    echo -n "drug?links.csv file missing, trying to download it from Drugbank, please wait... "
    curl -Lfs -o filename.zip -u $email$dots$password https://go.drugbank.com/releases/5-1-7/downloads/approved-drug-links
    if [ -e filename.zip ]
    then
        echo success ; unzip -qn filename.zip ; rm filename.zip
    else
        echo "failed! Check the connectivity link to Drugbank and run vini_init again!" ; exit 
    fi
else
    filename=drug?links.csv     #update drug?links.csv file if older than 7 days.
    hundred_days_ago=$(date -d 'now - 7 days' +%s) #https://www.thegeekstuff.com/2012/11/linux-touch-command/
    file_time=$(date -r $filename +%s)
    if (( file_time <= hundred_days_ago ))
    then
      echo -n "drug?links.csv file is more than 7 days old, updating..."
      curl -Lfs -o filename.zip -u $email$dots$password https://go.drugbank.com/releases/5-1-7/downloads/approved-drug-links
      if  [ -e filename.zip ]
      then
          echo success ; rm drug?links.csv ; unzip -qn filename.zip ; rm filename.zip ; touch drug?links.csv
      else
          echo "failed! Check the connectivity link to Drugbank and run vini_init again!" ; exit
      fi
    fi
fi

> $WORKDIR/ligands_list.tmp
while read -r line #remove from the ligands list any entry starting with #
do
    process=`echo $line | cut -c1`
    if [ $process != "#" ]    #proceed if entry not commented
    then
        echo $line >> $WORKDIR/ligands_list.tmp
    else
        echo "entry" $line "will be not analysed. Original list will be saved to $vini_dir/ligands/ligands_list.sav"
    fi
done < $vini_dir/ligands/ligands_list

mv $WORKDIR/ligands_list.tmp $vini_dir/ligands/ligands_list

while read -r line
do
    line=`head -"$lineno" $vini_dir/ligands/ligands_list | tail -1` #get drugname
    drugname=`echo $line | awk -F','   '{print $1}'`
    echo $drugname > test ; words=`wc -w < test` ; rm test          #put a question mark if 2 words
    if  [ $words -eq 2 ] #then put ? in between
    then
        line=`echo $line | tr ',' ' '`
        word1=`echo $line | awk '{print $1}'` ;  word2=`echo $line | awk '{print $2}'` 
        drugname=`echo $word1"?"$word2`
    fi

    if  [ -e $vini_dir/ligands/pdb_files/$drugname$pdb ] #check if drug is in repo
    then
        echo $drugname "already in repo."
    else
        echo -n "searching for" $drugname "in Drugbank..."
        echo "grep" "\"$drugname\"" "drug?links.csv" > search
        sh search > tmp
        inlines=`wc -l < $vini_dir/tmp`   #there may be several lines with a same drug name
        if  [ $inlines -gt $NULL ]
        then   
            echo "drug found." 
            inline=`head -1 $vini_dir/tmp`
            DBID=`echo $inline | tr "," " " | awk '{print $1}'`
            if  [ $words -eq $ONES ]                  #check if a drug is small molecule or biotech
            then
                dtype=`echo $line | awk '{print $2}'` 
            else
                dtype=`echo $line | awk '{print $3}'` 
            fi
            if [ $dtype == S ]
            then
                echo $drugname "is a small molecule drug"
                echo -n "downloading" $drugname "pdb file from Drugbank..."
                curl -Lfs -o $vini_dir/ligands/pdb_files/$drugname$pdb https://www.drugbank.ca/structures/small_molecule_drugs/$DBID$pdb
                echo ""
            else
                grep $DBID drug?links.csv > tmp.csv               #read Uniprot ID
                cut -d, -f2 --complement tmp.csv > tmp #delete 2nd column (name)
                uniprot_id=`cat tmp | tr "," " " | awk '{print $6}'` 
                echo $drugname "is biotech drug. Uniprot ID is" $uniprot_id
                echo -n "Trying to predict its structure, please wait..."
                sh predict_protein_structure ${DOWNLOAD_DIR} ${uniprot_id} ${drugname}
                if  [ ! -e $DOWNLOAD_DIR/$drugname$pdb ]
                then
                    drugname=`echo $drugname | tr "?" " " ` #comment this drug in ligands_list
                    echo "prediction failed." $drugname "will be not analyzed." 
                    awk -v "lineno=$lineno"  'NR==lineno { $0 = "#" $0 }; 1' $vini_dir/ligands/ligands_list > tmp
                    mv tmp $vini_dir/ligands/ligands_list
                else
                    echo "success."
                fi
            fi
        else
            echo -n "drug not found. Entry will be deleted from the list..." 
            awk -v "lineno=$lineno"  'NR==lineno { $0 = "#" $0 }; 1' $vini_dir/ligands/ligands_list > tmp
            mv tmp $vini_dir/ligands/ligands_list
        fi
    fi
done < $vini_dir/ligands/ligands_list
rm -f tmp.csv tmp search
