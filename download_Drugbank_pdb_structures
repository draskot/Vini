NULL=0
ONES=1

echo -n "checking if pdb files are in place, please wait..."
lineno=1
while read -r line
do
    type=`echo $line | awk -F','   '{print $2}'`
    if [ $type == S ]
    then
        drugname=`echo $line | awk -F','   '{print $1}'`
        echo $drugname > priv ; words=`wc -w < priv` ; rm priv #put a question mark if 2 words
        if  [ $words -eq 2 ] #then put ? in between
        then
            addline=`echo $line | tr ',' ' '`
            word1=`echo $addline | awk '{print $1}'`
            word2=`echo $addline | awk '{print $2}'` 
            drug=`echo $word1"?"$word2`
        else
            drug=$drugname
        fi
        if  [ ! -e $vini_dir/ligands/pdb_files/${drug}.pdb ] #check if drug is in repo
        then
            echo "grep -w" "\"$drug\"" "drug?links.csv" > search
            sh search > tmp
            inlines=`wc -l < $vini_dir/tmp`  #there may be several lines with a same drug name
            if  [ $inlines -gt $NULL ]
            then   
                inline=`head -1 $vini_dir/tmp`
                DBID=`echo $inline | tr "," " " | awk '{print $1}'`
                echo -n "downloading" $drug "pdb file from Drugbank..."
                wget -O $vini_dir/ligands/pdb_files/${drug}.pdb -q https://www.drugbank.ca/structures/small_molecule_drugs/${DBID}.pdb
            else
                echo "drug" $drug "not found in Drugbank and will not be analysed." 
                awk -v "lineno=$lineno"  'NR==lineno { $0 = "#" $0 }; 1' $vini_dir/ligands/ligands_list > tmp
                mv tmp $vini_dir/ligands/ligands_list
            fi
        fi
        let "lineno++"
    fi
done < $vini_dir/ligands/ligands_list
echo "done."
rm -f tmp.csv tmp search
