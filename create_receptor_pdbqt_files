
cancer_type=`cat $WORKDIR/cancer_type`
job_status=`cat $WORKDIR/job_status`
job_submit=`cat $WORKDIR/job_submit`
max_jobs=`cat $WORKDIR/max_jobs`

dir=$WORKDIR/${cancer_type}_data

cd $WORKDIR/${cancer_type}_data
rm -f *pdbqt

echo -n "renaming receptors to complexes..."
ls receptor_???.pdb > rlist
n=1
while read -r line
do
    printf -v i "%03d" $n
    cp $line complex_${i}.pdb
    let "n++"
done < rlist
echo "done."

echo "Creating receptor pdbqt files..."
for j in complex_???.pdb  #create pdbqt files
do
    b=`basename $j .pdb`
    cat $WORKDIR/Vina > Vina_run
    echo "#SBATCH --job-name=create_pdbqt"   >> Vina_run
    echo "#SBATCH --output=$dir/prepare.out" >> Vina_run
    echo "#SBATCH --output=$dir/prepare.err" >> Vina_run
    if [ -e $WORKDIR/failed_nodes ]
    then
        failed_nodes=`cat $WORKDIR/failed_nodes`
        echo "#SBATCH --exclude=${failed_nodes}" >> Vina_run  #node not working properly
    fi
    echo "prepare_receptor -r $dir/$b.pdb -o $dir/$b.pdbqt " >> Vina_run
    #echo "prepare_receptor -U nphs_lps_waters -r $dir/$b.pdb -o $dir/$b.pdbqt " >> Vina_run
    chmod +x Vina_run
    $job_submit Vina_run
    sh $vini_dir/jobs_control_script ${job_status} ${max_jobs}
done
sh $vini_dir/wait_until_jobs_finish

n=1
> $WORKDIR/receptors_contracted.new
while read -r line
do
    printf -v i "%03d" $n
    if [ ! -e complex_${i}.pdbqt ]
    then                                                        
        success=nopdbqt
    else
        success=pdbqt   #flag in the 7th column of receptors_contracted file
    fi
    echo $line $success >> $WORKDIR/receptors_contracted.new
    let "n++"
done < $WORKDIR/receptors_contracted

mv $WORKDIR/receptors_contracted.new $WORKDIR/receptors_contracted

