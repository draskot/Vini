
cancer_type=`cat $WORKDIR/cancer_type`
job_status=`cat $WORKDIR/job_status`
job_submit=`cat $WORKDIR/job_submit`
max_jobs=`cat $WORKDIR/max_jobs`
failed_nodes=`cat $WORKDIR/cpu_failed_nodes`

dir=$WORKDIR/${cancer_type}_data

cd $WORKDIR/${cancer_type}_data
rm -f *pdbqt

echo "Renaming receptors to complexes, please wait."
ls receptor_???.pdb > rlist
n=1
while read -r line
do
    printf -v i "%03d" $n
    cp $line complex_${i}.pdb
    let "n++"
done < rlist

echo "Creating receptor pdbqt files.Please wait."
partition=`cat $WORKDIR/cpu_partition`
for j in complex_???.pdb 
do
    b=`basename $j .pdb`
    echo "#!/bin/bash"                                                            > prepare_receptor
    echo "#SBATCH --time=00:60:00"                                               >> prepare_receptor
    echo "#SBATCH --partition="$partition                                        >> prepare_receptor
    echo "#SBATCH --cpus-per-task=1"                                             >> prepare_receptor
    echo "#SBATCH --mem=2gb"                                                     >> prepare_receptor
    echo "#SBATCH --job-name=create_pdbqt"                                       >> prepare_receptor
    echo "#SBATCH --output=$dir/prepare_receptor.out"                            >> prepare_receptor
    echo "#SBATCH --error=$dir/prepare_receptor.err"                             >> prepare_receptor
    echo "#SBATCH --exclude=${failed_nodes}"                                     >> prepare_receptor
    echo "prepare_receptor -r $dir/$b.pdb -o $dir/$b.pdbqt "                     >> prepare_receptor
    #echo "prepare_receptor -U nphs_lps_waters -r $dir/$b.pdb -o $dir/$b.pdbqt " >> prepare_receptor
    chmod +x prepare_receptor
    $job_submit prepare_receptor
    sh $vini_dir/jobs_control_script ${job_status} ${max_jobs}
done
sh $vini_dir/wait_until_jobs_finish

n=1
> $WORKDIR/receptors_contracted.new
while read -r line
do
    printf -v i "%03d" $n
    if [ ! -e complex_${i}.pdbqt ]
    then                                                        
        success=nopdbqt
    else
        success=pdbqt   #flag in the 7th column of receptors_contracted file
    fi
    echo $line $success >> $WORKDIR/receptors_contracted.new
    let "n++"
done < $WORKDIR/receptors_contracted

mv $WORKDIR/receptors_contracted.new $WORKDIR/receptors_contracted

