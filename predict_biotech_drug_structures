prediction_model=`cat $WORKDIR/biotech_drug_structure_prediction`
partition=`cat  $WORKDIR/cpu_partition`

if [ ${prediction_model} == AlphaFold ]
then
    if [ $partition == cpu ]
    then
        cpus=`cat $WORKDIR/AlphaFold_cpus`
    else
        cpus=`cat $WORKDIR/AlphaFold_gpus`
    fi
    mem=`cat $WORKDIR/AlphaFold_mem`
    base=`cat $WORKDIR/AlphaFold_base`
    model=`cat $WORKDIR/AlphaFold_biotech_prediction_model`
fi


rm -f error
NULL=0   
MAX_NODES=`cat $WORKDIR/nodes`
while read -r line
do
    drug=`echo $line | awk -F','  '{print $1}'`
    type=`echo $line | awk -F','  '{print $2}'`
    if  [ $type == P ]
    then
        lines=`echo "$drug" | grep -oP 'mab.*?\b' | wc -l`
        if [ $lines -eq $NULL ]
        then
            echo "$drug is not mAb! Don't know how to make it's structure. Exiting." ; > error
            break
        fi
        if  [ ! -e $vini_dir/ligands/pdb_files/${drug}.pdb ]
        then
            if  [ ! -e ${vini_dir}/ligands/fasta_files/${drug}.fasta ]
            then
                echo ${drug}.fasta "not found in" $vini_dir/ligands/fasta_files "folder."
                echo "Please provide ${drug} fasta sequence or remove it from the list. Then start Vini again."
                echo "Press Ctrl-C to exit."
            else
                if  [ ${prediction_model} == SWISS-MODEL ]
                then
                    echo "predicting biotech drug structures with ${prediction_model}"
                    sh $vini_dir/predict_mab_structures_with_SWISS-MODEL
                else
                    sh $vini_dir/nodes_control_script ${MAX_NODES}
                    fasta_file=${vini_dir}/ligands/fasta_files/${drug}.fasta
                    if [ $prediction_model == AlphaFold ]
                    then                      
                        sh $vini_dir/predict_with_AlphaFold ${cpus} ${mem} ${partition} ${base} ${model} ${fasta_file}
                    else
                        sh $vini_dir/predict_mab_structure_with_Rosetta ${drug} ${partition} ${fasta_file}
                    fi
                    echo "Predicting ${drug} structure with ${prediction_model}."
                fi
            fi
        else
            echo "  ${drug}.pdb found, continuing."
        fi
    fi
done < $vini_dir/ligands/ligands_list

if  [ -e error ]
then
    exit
fi

sh $vini_dir/wait_until_jobs_finish

rm -f error
while read -r line   #copy generated pdb structures to the $vini_dir/ligands/pdb_files directory
do
    drug=`echo $line | awk -F',' '{print $1}'`
    type=`echo $line | awk -F',' '{print $2}'`
    if  [ $type == P ]
    then
        if  [ -e $WORKDIR/${drug}/${drug}.pdb ] 
        then
            cp $WORKDIR/${drug}/${drug}.pdb $vini_dir/ligands/pdb_files
        else
            echo "Error creating $drug structure! Start Vini again and try predict structure with some other tool."
            > error
        fi
    fi
done < $vini_dir/ligands/ligands_list
