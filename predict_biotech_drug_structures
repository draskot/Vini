
prediction_model=`cat $WORKDIR/biotech_drug_structure_prediction`


if [ $prediction_model == A ]
then
    partition=`cat  $WORKDIR/AlphaFold_partition`      #Define AlphaFold parameters
    if [ $partition == cpu ]
    then
        cpus=`cat $WORKDIR/AlphaFold_cpus`
    else
        cpus=`cat $WORKDIR/AlphaFold_gpus`
    fi
    mem=`cat $WORKDIR/AlphaFold_mem`
    base=`cat $WORKDIR/AlphaFold_base`
    model=`cat $WORKDIR/AlphaFold_biotech_prediction_model`
fi

NULL=0   
MAX_NODES=`cat $WORKDIR/nodes`
while read -r line
do
    drug=`echo $line | awk -F','  '{print $1}'`
    type=`echo $line | awk -F','  '{print $2}'`
    if  [ $type == P ]
    then
        if  [ ! -e $vini_dir/ligands/pdb_files/${drug}.pdb ]
        then
            if  [ ! -e ${vini_dir}/ligands/fasta_files/${drug}.fasta ]
            then
                echo ${drug}.fasta "not found in" $vini_dir/ligands/fasta_files "folder."
                echo "Please provide ${drug} fasta sequence or remove it from the list. Then start Vini again."
                echo "Press Ctrl-C to exit."
            else
                if  [ ${prediction_model} == S ]
                then
                    echo "predicting biotech drug structures with SWISS-MODEL"
                    sh $vini_dir/predict_mab_structures_with_SWISS-MODEL
                else
                    sh $vini_dir/nodes_control_script ${MAX_NODES}
                    fasta_file=${vini_dir}/ligands/fasta_files/${drug}.fasta
                    #lines=`echo "$drug" | grep -oP 'mab.*?\b' | wc -l`
                    #if [ $lines -eq $NULL ]
                    #then                        #drug is  not mAb
                        echo "Predicting ${drug} structure with AlphaFold."

                        sh $vini_dir/predict_with_AlphaFold ${cpus} ${mem} ${partition} ${base} ${model} ${fasta_file}
                    #else
                    #    echo "Predicting ${drug} structure with Rosetta."
                    #    sh $vini_dir/predict_mab_structure_with_Rosetta ${drug}
                    #fi
                fi
            fi
        else
            echo "  ${drug}.pdb found, continuing."
        fi
    fi
done < $vini_dir/ligands/ligands_list
