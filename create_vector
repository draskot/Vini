#  affinity vector is created and multiplied with gene expression values from receptors_contracted file

#input params: target_dir, M, L, J, I
#output params: SLEM written in $WORKDIR/SLEM_values file

target_dir=$1
M=$2
L=$3
J=$4
I=$5

conversion_unit=2.00
ls $target_dir/log* > tmp
logs=`wc -l < tmp`

> $target_dir/vec
for (( N=1; N<$((logs+1)); N++ ))                     #create energy vector / convert REU to kcal/mol values
do
    printf -v comp_index "%03d" $N
    mode=`cat ${target_dir}/log_${comp_index} | awk '{print $1}'`
    energy=`cat ${target_dir}/log_${comp_index} | awk '{print $2}'`
    if  [ $energy != ERROR ]
    then
        if  [ $mode == Rosetta ]
        then
            energy=`echo ${energy} ${conversion_unit} | awk '{print $1 / $2}'`
        fi
    fi
    echo $energy >> $target_dir/vec
done

grep ERROR $target_dir/vec > tmp                      #replace ERROR entries with random value
if [ -s tmp ]
then
    echo "Normalizing energy vector."
    source $INSTALL/miniconda3/bin/activate
    conda activate env310
    python $vini_dir/get_random_value.py
    conda deactivate
fi
    
while read -r line
do
    genex=`echo $line | awk '{print $6}'`
    if  [ -z "$genex" ]                                    #set genex to 1 if unset or empty
    then
        genex=1
    fi
    affinity=`head -"$index" ${target_dir}/vec | tail -1`
    product=`echo $genex $affinity | awk '{print $1 * $2}'`
    echo $product >> ${target_dir}/vec.tmp
    let "index++"
done < receptors_contracted

mv $target_dir/vec.tmp ${target_dir}/vec
