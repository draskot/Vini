
cpus=`cat $WORKDIR/AlphaFold_cpus`
mem=`cat $WORKDIR/AlphaFold_mem`
partition=`cat  $WORKDIR/AlphaFold_partition`
base=`cat $WORKDIR/AlphaFold_base`
model=monomer

NULL=0

MAX_NODES=`cat $WORKDIR/nodes`
biotech_drugs_prediction_model=`cat $WORKDIR/biotech_drugs_prediction_model`
while read -r line
do
    drug=`echo $line | awk -F','  '{print $1}'`
    type=`echo $line | awk -F','  '{print $2}'`
    if  [ $type == P ]
    then
        if  [ ! -e $vini_dir/database/ligands/pdb_files/${drug}.pdb ]
        then
            if  [ ! -e ${vini_dir}/database/ligands/fasta_files/${drug}.fasta ]
            then
                echo ${drug}.fasta "not found in" $vini_dir/database/ligands/fasta_files "folder."
                echo "Please provide ${drug} fasta sequence or remove it from the list. Then start Vini again."
                echo "Press Ctrl-C to exit."
            else
                if  [ ${biotech_drugs_prediction_model} == S ]
                then
                    echo "predicting biotech drug structures with SWISS-MODEL"
                    sh $vini_dir/predict_mab_structures_with_SWISS-MODEL
                else
                    sh $vini_dir/nodes_control_script ${MAX_NODES}
                    fasta_file=${vini_dir}/database/ligands/fasta_files/${drug}.fasta
                    lines=`echo "$drug" | grep -oP 'mab.*?\b' | wc -l`
                    if [ $lines -eq $NULL ]
                    then                                        #Only one chain found, not a mAb drug
                        echo "Predicting ${drug} structure with AlphaFold."
                        sh $vini_dir/predict_with_AlphaFold ${cpus} ${mem} ${partition} ${base} ${model} ${fasta_file}
                    else
                        echo "Predicting ${drug} structure with Rosetta."
                        sh $vini_dir/predict_mab_structure_with_Rosetta ${drug}
                    fi
                fi
            fi
        else
            echo "  ${drug}.pdb found in the database, continuing."
        fi
    fi
done < $vini_dir/database/ligands/ligands_list
